generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 列舉型別 ====================

enum ReportCategory {
  OPERATION   // 營運
  HR          // 人資
  FINANCE     // 財務
  MARKETING   // 行銷
  MEMBER      // 會員
  SYSTEM      // 系統
}

enum StoreType {
  MED         // 醫美
  SPA         // 岩盤浴
  OTHER       // 其他
}

enum StaffRole {
  STORE_MANAGER     // 店長
  AREA_MANAGER      // 區經理
  SUPERVISOR        // 主管
  SENIOR_EXECUTIVE  // 高階主管
  SPECIALIST        // 專員
  OTHER             // 其他
}

// ==================== 報表 ====================

model Report {
  id          String         @id @default(cuid())
  code        String         @unique
  name        String
  category    ReportCategory
  description String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  templateReports    TemplateReport[]
  storeAuthScopes    StoreAuthScope[]
  groupManagerScopes GroupManagerScope[]

  @@index([category])
  @@index([code])
}

// ==================== 人員 ====================

model Staff {
  id        String    @id @default(cuid())
  staffCode String    @unique
  name      String
  nickname  String?
  email     String?   @unique
  role      StaffRole
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  managedStores    StoreManager[]
  authorizedStores StoreAuthUser[]
  groupManagers    GroupManager[]

  @@index([role])
  @@index([name])
}

// ==================== 門市 ====================

model Store {
  id            String    @id @default(cuid())
  code          String    @unique
  name          String
  type          StoreType
  roleEmail     String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  managers        StoreManager[]
  authorizedUsers StoreAuthUser[]
  groupStores     GroupStore[]

  @@index([type])
  @@index([code])
}

model StoreManager {
  id        String    @id @default(cuid())
  storeId   String
  staffId   String
  isPrimary Boolean   @default(true)
  startDate DateTime  @default(now())
  endDate   DateTime?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  staff Staff @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([storeId, staffId, isPrimary])
  @@index([storeId])
  @@index([staffId])
}

model StoreAuthUser {
  id        String   @id @default(cuid())
  storeId   String
  staffId   String
  roleDesc  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  store  Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  staff  Staff            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  scopes StoreAuthScope[]

  @@unique([storeId, staffId])
  @@index([storeId])
  @@index([staffId])
}

model StoreAuthScope {
  id              String @id @default(cuid())
  storeAuthUserId String
  reportId        String

  storeAuthUser StoreAuthUser @relation(fields: [storeAuthUserId], references: [id], onDelete: Cascade)
  report        Report        @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([storeAuthUserId, reportId])
}

// ==================== 群組 ====================

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  isAllStores Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stores   GroupStore[]
  managers GroupManager[]

  @@index([name])
}

model GroupStore {
  id      String @id @default(cuid())
  groupId String
  storeId String

  group Group @relation(fields: [groupId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([groupId, storeId])
}

model GroupManager {
  id        String   @id @default(cuid())
  groupId   String
  staffId   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  group  Group               @relation(fields: [groupId], references: [id], onDelete: Cascade)
  staff  Staff               @relation(fields: [staffId], references: [id], onDelete: Cascade)
  scopes GroupManagerScope[]

  @@unique([groupId, staffId])
  @@index([groupId])
  @@index([staffId])
}

model GroupManagerScope {
  id             String @id @default(cuid())
  groupManagerId String
  reportId       String

  groupManager GroupManager @relation(fields: [groupManagerId], references: [id], onDelete: Cascade)
  report       Report       @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([groupManagerId, reportId])
}

// ==================== 報表組合 ====================

model ReportTemplate {
  id           String   @id @default(cuid())
  templateCode String   @unique
  name         String
  description  String?
  isAllReports Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reports TemplateReport[]

  @@index([name])
}

model TemplateReport {
  id         String @id @default(cuid())
  templateId String
  reportId   String

  template ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  report   Report         @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([templateId, reportId])
}

// ==================== 日誌 ====================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model AICommandLog {
  id            String   @id @default(cuid())
  userId        String?
  inputText     String
  parsedAction  Json?
  isSuccess     Boolean
  errorMessage  String?
  executionTime Int?
  createdAt     DateTime @default(now())

  @@index([createdAt])
}
