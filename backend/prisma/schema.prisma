generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== 列舉型別 ====================

enum ReportCategory {
  OPERATION   // 營運
  HR          // 人資
  FINANCE     // 財務
  MARKETING   // 行銷
  MEMBER      // 會員
  SYSTEM      // 系統
}

enum StoreType {
  MED         // 醫美
  SPA         // 岩盤浴
  OTHER       // 其他
}

// ==================== 報表 ====================

model Report {
  id          String         @id @default(cuid())
  code        String         @unique
  name        String
  category    ReportCategory
  description String?
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  templateReports TemplateReport[]
  storeAuthScopes StoreAuthScope[]

  @@index([category])
  @@index([code])
}

// ==================== 門市 ====================

model Store {
  id            String    @id @default(cuid())
  code          String    @unique
  name          String
  type          StoreType
  roleEmail     String
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  managers        StoreManager[]
  authorizedUsers StoreAuthUser[]

  @@index([type])
  @@index([code])
}

model StoreManager {
  id          String    @id @default(cuid())
  storeId     String
  managerName String
  isPrimary   Boolean   @default(true)
  startDate   DateTime  @default(now())
  endDate     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, managerName, isPrimary])
  @@index([storeId])
}

model StoreAuthUser {
  id          String   @id @default(cuid())
  storeId     String
  userName    String
  roleDesc    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store  Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  scopes StoreAuthScope[]

  @@unique([storeId, userName])
  @@index([storeId])
}

model StoreAuthScope {
  id              String @id @default(cuid())
  storeAuthUserId String
  reportId        String

  storeAuthUser StoreAuthUser @relation(fields: [storeAuthUserId], references: [id], onDelete: Cascade)
  report        Report        @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([storeAuthUserId, reportId])
}

// ==================== 報表組合 ====================

model ReportTemplate {
  id           String   @id @default(cuid())
  templateCode String   @unique
  name         String
  description  String?
  isAllReports Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reports TemplateReport[]

  @@index([name])
}

model TemplateReport {
  id         String @id @default(cuid())
  templateId String
  reportId   String

  template ReportTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  report   Report         @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@unique([templateId, reportId])
}

// ==================== 日誌 ====================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model AICommandLog {
  id            String   @id @default(cuid())
  userId        String?
  inputText     String
  parsedAction  Json?
  isSuccess     Boolean
  errorMessage  String?
  executionTime Int?
  createdAt     DateTime @default(now())

  @@index([createdAt])
}
