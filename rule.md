# N-Report 權限中控台 - 系統規則說明

## 一、系統架構概述

N-Report 權限中控台是一個統一存取控制系統（Unified Access Control），用於管理門市人員的報表存取權限。

---

## 二、資料模型

### 2.1 門市 (Store)

| 欄位 | 說明 | 範例 |
|------|------|------|
| `code` | 門市代碼（唯一識別碼，不可修改） | `BZ_MED`, `TP_SPA` |
| `name` | 門市名稱 | 板橋醫美、忠孝岩盤浴 |
| `roleEmail` | 角色 Email（Role Email） | `bz_med.manager@company.com` |
| `primaryManager` | 主要店經理 | `{ name: '王小明', status: 'active' }` |
| `authorizedUsers` | 其他授權人員清單 | `[{ name, role, scopes }]` |

### 2.2 群組 (Group)

| 欄位 | 說明 | 範例 |
|------|------|------|
| `name` | 群組名稱 | 醫美多店管理組、北區督導組 |
| `stores` | 包含的門市名稱清單 | `['板橋醫美', '三峽醫美']` |
| `managers` | 群組管理者清單 | `[{ name: 'Tina', scopes: ['A','B','C'] }]` |

---

## 三、報表權限分級 (Scope)

| 代碼 | 報表類型 | 敏感等級 | 說明 |
|------|----------|----------|------|
| **A** | 營收報表 | 高（敏感） | 包含營業額、利潤等財務數據 |
| **B** | 營運報表 | 中（一般） | 包含營運指標、人員出勤等 |
| **C** | 庫存報表 | 低 | 包含庫存狀態、進出貨紀錄 |

---

## 四、權限規則

### 4.1 門市層級權限

#### 主要店經理 (Primary Manager)
- 每間門市**只能有一位**主要店經理
- 主要店經理自動繼承該門市的 Role Email
- 可透過「權限移轉」更換店經理
- 若設為「暫時懸缺」，則該門市無主要負責人

#### 細部授權人員 (Granular Users)
- 每間門市可以有**多位**細部授權人員
- 每位人員需指定可存取的報表範圍（Scope A/B/C）
- 細部權限獨立於主要店經理權限

### 4.2 群組層級權限

#### 群組管理者
- 群組可包含多間門市
- 群組管理者可存取**所有群組內門市**的指定報表
- 適用於區督導、區經理等跨店管理角色
- 每個群組可有多位管理者，各自設定不同的報表權限

---

## 五、操作規則

### 5.1 門市管理操作

| 操作 | 說明 | 影響範圍 |
|------|------|----------|
| 新展店設定 | 建立新門市，自動生成 Role Email | 新增一筆門市資料 |
| 門市設定 | 修改門市名稱、Role Email | 同步更新 Google Drive 權限與 n8n 分派規則 |
| 權限移轉 | 更換主要店經理 | 新店經理繼承 Role Email |
| 加人 | 新增細部授權人員 | 該人員獲得指定報表存取權 |

### 5.2 群組管理操作

| 操作 | 說明 | 影響範圍 |
|------|------|----------|
| 新增管理群組 | 建立新群組，選擇門市與管理者 | 管理者獲得群組內所有門市的報表權限 |
| 編輯群組 | 修改群組名稱、調整包含門市 | 影響管理者可存取的門市範圍 |
| 刪除群組 | 移除整個群組 | 所有管理者失去該群組的權限 |
| 新增管理者 | 為群組新增管理者 | 新管理者獲得群組報表權限 |
| 移除管理者 | 從群組移除管理者 | 該管理者失去群組報表權限 |

---

## 六、Role Email 規則

### 6.1 命名規範
```
{門市代碼小寫}.manager@company.com
```

### 6.2 範例
| 門市代碼 | Role Email |
|----------|------------|
| `BZ_MED` | `bz_med.manager@company.com` |
| `TP_SPA` | `tp_spa.manager@company.com` |
| `TC_SPA` | `tc_spa.manager@company.com` |

### 6.3 同步機制
修改 Role Email 時，系統會同步更新：
1. Google Drive 資料夾存取權限
2. n8n 自動化分派規則

---

## 七、AI 助手指令規則

AI 助手支援自然語言指令，解析後執行以下動作：

| 動作類型 | 觸發語句範例 | 參數 |
|----------|--------------|------|
| `ASSIGN_PRIMARY` | 「把板橋醫美的店長換成 Tina」 | storeName, managerName |
| `ADD_GRANULAR` | 「讓 David 可以看忠孝岩盤浴的營收報表」 | storeName, userName, role, scopes |
| `CREATE_STORE` | 「新增一間台北醫美門市」 | name, code |
| `UPDATE_STORE_EMAIL` | 「修改板橋醫美的 Email 為 xxx@company.com」 | storeName, newEmail |

---

## 八、權限繼承關係圖

```
┌─────────────────────────────────────────────────────────┐
│                      群組 (Group)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │  管理者 A   │  │  管理者 B   │  │  管理者 C   │     │
│  │ Scope: ABC  │  │ Scope: AB   │  │ Scope: B    │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│                          │                              │
│              ┌───────────┼───────────┐                  │
│              ▼           ▼           ▼                  │
│         ┌────────┐  ┌────────┐  ┌────────┐             │
│         │ 門市 1 │  │ 門市 2 │  │ 門市 3 │             │
│         └────────┘  └────────┘  └────────┘             │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                     門市 (Store)                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │              主要店經理 (Primary)                  │  │
│  │         繼承 Role Email，完整權限                  │  │
│  └──────────────────────────────────────────────────┘  │
│                          │                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │           細部授權人員 (Granular)                  │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐          │  │
│  │  │ 人員 A  │  │ 人員 B  │  │ 人員 C  │          │  │
│  │  │Scope: A │  │Scope: AB│  │Scope: BC│          │  │
│  │  └─────────┘  └─────────┘  └─────────┘          │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

## 九、安全性規則

1. **門市代碼不可修改**：建立後作為唯一識別碼，確保資料一致性
2. **刪除操作需確認**：刪除群組或移除管理者前，系統會彈出確認對話框
3. **權限變更即時同步**：所有變更會即時同步至 Google Drive 與 n8n
4. **角色分離**：主要店經理與細部授權人員權限獨立管理

---

## 十、使用者角色定義

| 角色 | 典型職位 | 權限範圍 |
|------|----------|----------|
| 主要店經理 | 店長 | 單一門市完整權限 |
| 細部授權人員 | 儲備幹部、專員 | 單一門市部分報表 |
| 群組管理者 | 區督導、區經理 | 多門市指定報表 |
| 系統管理員 | 營業部主管 | 全系統管理權限 |
