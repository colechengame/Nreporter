# é›™ä¾†æºå ±è¡¨ç³»çµ±æ¶æ§‹è¨­è¨ˆ

## å•é¡ŒèƒŒæ™¯

ç³»çµ±éœ€è¦æ•´åˆå…©å€‹å ±è¡¨ä¾†æºï¼š
1. **èˆŠç‰ˆ N8N è¨‚é–±å¼å ±è¡¨**ï¼šé€éæª”åè§£æï¼Œè‡ªå‹•æ­¸æª”åˆ° Google Drive
2. **æ–°ç‰ˆç³»çµ±å ±è¡¨**ï¼šç›´æ¥æŒ‡å‘å°æ‡‰çš„ Google Drive è³‡æ–™å¤¾

---

## æ ¸å¿ƒæŒ‘æˆ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æŒ‘æˆ°åˆ†æ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. æª”åè§£æè¦å‰‡åˆ†æ•£åœ¨ N8Nï¼Œé›£ä»¥ç¶­è­·                              â”‚
â”‚  2. é–€å¸‚/å ±è¡¨çš„æ˜ å°„é—œä¿‚æ²’æœ‰ä¸­å¤®ç®¡ç†                               â”‚
â”‚  3. Google Drive è³‡æ–™å¤¾ ID æ•£è½å„è™•                              â”‚
â”‚  4. æ–°èˆŠç³»çµ±å¯èƒ½ç”¢ç”Ÿé‡è¤‡æˆ–è¡çª                                    â”‚
â”‚  5. æ¬Šé™è®Šæ›´æ™‚éœ€è¦åŒæ­¥å¤šè™•                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å»ºè­°æ¶æ§‹ï¼šCentral Registry Pattern (ä¸­å¤®è¨»å†Šæ¨¡å¼)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•´é«”æ¶æ§‹åœ–                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      N-Report æ¬Šé™ä¸­æ§å°         â”‚
                    â”‚      (Frontend + API)           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                           â”‚
â”‚                        Central Registry (ä¸­å¤®è¨»å†Šä¸­å¿ƒ)                     â”‚
â”‚                                                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Store       â”‚   â”‚ Report      â”‚   â”‚ DriveFolder â”‚   â”‚ FilePattern â”‚  â”‚
â”‚   â”‚ Registry    â”‚   â”‚ Registry    â”‚   â”‚ Registry    â”‚   â”‚ Registry    â”‚  â”‚
â”‚   â”‚             â”‚   â”‚             â”‚   â”‚             â”‚   â”‚             â”‚  â”‚
â”‚   â”‚ â€¢ é–€å¸‚ä»£ç¢¼   â”‚   â”‚ â€¢ å ±è¡¨ä»£ç¢¼   â”‚   â”‚ â€¢ è³‡æ–™å¤¾ID  â”‚   â”‚ â€¢ æª”åè¦å‰‡   â”‚  â”‚
â”‚   â”‚ â€¢ é–€å¸‚åç¨±   â”‚   â”‚ â€¢ å ±è¡¨åç¨±   â”‚   â”‚ â€¢ è·¯å¾‘æ˜ å°„   â”‚   â”‚ â€¢ è§£ææ¨¡å¼   â”‚  â”‚
â”‚   â”‚ â€¢ Role Emailâ”‚   â”‚ â€¢ åˆ†é¡       â”‚   â”‚ â€¢ æ¬Šé™å¿«å–   â”‚   â”‚ â€¢ ä¾†æºæ¨™è¨˜   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                           â”‚
â”‚                              PostgreSQL                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                               â”‚
                    â–¼                               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚    ä¾†æº A: N8N å·¥ä½œæµ      â”‚   â”‚    ä¾†æº B: æ–°ç‰ˆç³»çµ±        â”‚
    â”‚    (èˆŠç‰ˆè¨‚é–±å¼å ±è¡¨)        â”‚   â”‚    (ç›´æ¥ç”¢ç”Ÿå ±è¡¨)          â”‚
    â”‚                           â”‚   â”‚                           â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ 1. æ”¶åˆ°å ±è¡¨æª”æ¡ˆ     â”‚  â”‚   â”‚  â”‚ 1. ç³»çµ±ç”¢ç”Ÿå ±è¡¨     â”‚  â”‚
    â”‚  â”‚    (Email/FTP/API)  â”‚  â”‚   â”‚  â”‚    (æ’ç¨‹/è§¸ç™¼)      â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚             â”‚             â”‚   â”‚             â”‚             â”‚
    â”‚             â–¼             â”‚   â”‚             â–¼             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ 2. å‘¼å« Registry    â”‚  â”‚   â”‚  â”‚ 2. å‘¼å« Registry    â”‚  â”‚
    â”‚  â”‚    è§£ææª”å         â”‚  â”‚   â”‚  â”‚    å–å¾—ç›®æ¨™è³‡æ–™å¤¾   â”‚  â”‚
    â”‚  â”‚    GET /api/resolve â”‚  â”‚   â”‚  â”‚    GET /api/folder  â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚             â”‚             â”‚   â”‚             â”‚             â”‚
    â”‚             â–¼             â”‚   â”‚             â–¼             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ 3. å–å¾—:            â”‚  â”‚   â”‚  â”‚ 3. å–å¾—:            â”‚  â”‚
    â”‚  â”‚    - é–€å¸‚è³‡è¨Š       â”‚  â”‚   â”‚  â”‚    - è³‡æ–™å¤¾ ID      â”‚  â”‚
    â”‚  â”‚    - å ±è¡¨é¡å‹       â”‚  â”‚   â”‚  â”‚    - æ¬Šé™æ¸…å–®       â”‚  â”‚
    â”‚  â”‚    - ç›®æ¨™è³‡æ–™å¤¾ ID  â”‚  â”‚   â”‚  â”‚    - æª”æ¡ˆå‘½åè¦å‰‡   â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚             â”‚             â”‚   â”‚             â”‚             â”‚
    â”‚             â–¼             â”‚   â”‚             â–¼             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ 4. ä¸Šå‚³è‡³           â”‚  â”‚   â”‚  â”‚ 4. ä¸Šå‚³è‡³           â”‚  â”‚
    â”‚  â”‚    Google Drive     â”‚  â”‚   â”‚  â”‚    Google Drive     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚                           â”‚   â”‚                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      Google Drive         â”‚
                    â”‚                           â”‚
                    â”‚  /N-Report å ±è¡¨ç³»çµ±/       â”‚
                    â”‚  â”œâ”€â”€ /é–€å¸‚å ±è¡¨/            â”‚
                    â”‚  â”‚   â”œâ”€â”€ /æ¿æ©‹å…‰æ¾¤é†«ç¾/    â”‚
                    â”‚  â”‚   â”‚   â”œâ”€â”€ /ç‡Ÿé‹/        â”‚
                    â”‚  â”‚   â”‚   â”œâ”€â”€ /äººè³‡/        â”‚
                    â”‚  â”‚   â”‚   â””â”€â”€ /è²¡å‹™/        â”‚
                    â”‚  â”‚   â”œâ”€â”€ /å¿ å­å…‰æ¾¤/        â”‚
                    â”‚  â”‚   â””â”€â”€ ...              â”‚
                    â”‚  â””â”€â”€ /å€åŸŸå ±è¡¨/            â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è³‡æ–™åº«è¨­è¨ˆ

### æ ¸å¿ƒè¡¨çµæ§‹

```sql
-- =====================================================
-- 1. é–€å¸‚è¨»å†Šè¡¨ (Store Registry)
-- =====================================================
CREATE TABLE stores (
    id              VARCHAR(36) PRIMARY KEY,
    code            VARCHAR(20) UNIQUE NOT NULL,  -- BZ_MED, ZX_SPA
    name            VARCHAR(100) NOT NULL,        -- æ¿æ©‹å…‰æ¾¤é†«ç¾
    type            VARCHAR(10) NOT NULL,         -- MED, SPA, OTHER
    role_email      VARCHAR(255) NOT NULL,        -- Role Email
    is_active       BOOLEAN DEFAULT true,
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

-- =====================================================
-- 2. å ±è¡¨è¨»å†Šè¡¨ (Report Registry)
-- =====================================================
CREATE TABLE reports (
    id              VARCHAR(36) PRIMARY KEY,
    code            VARCHAR(20) UNIQUE NOT NULL,  -- R001, R002
    name            VARCHAR(100) NOT NULL,        -- è­·ç†éƒ¨æ¶ˆè€—å ±è¡¨
    category        VARCHAR(20) NOT NULL,         -- OPERATION, HR, FINANCE
    description     TEXT,
    is_active       BOOLEAN DEFAULT true,
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

-- =====================================================
-- 3. Google Drive è³‡æ–™å¤¾è¨»å†Šè¡¨ (æ ¸å¿ƒï¼)
-- =====================================================
CREATE TABLE drive_folders (
    id              VARCHAR(36) PRIMARY KEY,

    -- é—œè¯éµ (å¯é¸å¡«ï¼Œç”¨æ–¼æ˜ å°„)
    store_id        VARCHAR(36) REFERENCES stores(id),
    report_id       VARCHAR(36) REFERENCES reports(id),

    -- Google Drive è³‡è¨Š
    drive_folder_id VARCHAR(100) NOT NULL,        -- Google Drive Folder ID
    drive_path      VARCHAR(500),                 -- äººé¡å¯è®€è·¯å¾‘
    folder_type     VARCHAR(20) NOT NULL,         -- STORE_ROOT, REPORT_CATEGORY, REPORT_SPECIFIC

    -- å…ƒè³‡æ–™
    parent_folder_id VARCHAR(36) REFERENCES drive_folders(id),
    is_active       BOOLEAN DEFAULT true,
    last_synced_at  TIMESTAMP,
    created_at      TIMESTAMP DEFAULT NOW(),

    -- ç¢ºä¿å”¯ä¸€æ€§
    UNIQUE(store_id, report_id, folder_type)
);

-- ç¯„ä¾‹è³‡æ–™:
-- | store_id | report_id | folder_type      | drive_folder_id | drive_path                    |
-- |----------|-----------|------------------|-----------------|-------------------------------|
-- | store_1  | NULL      | STORE_ROOT       | 1abc...         | /é–€å¸‚å ±è¡¨/æ¿æ©‹å…‰æ¾¤é†«ç¾         |
-- | store_1  | NULL      | REPORT_CATEGORY  | 2def...         | /é–€å¸‚å ±è¡¨/æ¿æ©‹å…‰æ¾¤é†«ç¾/ç‡Ÿé‹    |
-- | store_1  | report_1  | REPORT_SPECIFIC  | 3ghi...         | /é–€å¸‚å ±è¡¨/æ¿æ©‹å…‰æ¾¤é†«ç¾/ç‡Ÿé‹/R001 |

-- =====================================================
-- 4. æª”åè§£æè¦å‰‡è¡¨ (çµ¦ N8N ç”¨)
-- =====================================================
CREATE TABLE file_patterns (
    id              VARCHAR(36) PRIMARY KEY,

    -- è§£æè¦å‰‡
    pattern_name    VARCHAR(100) NOT NULL,        -- è¦å‰‡åç¨± (äººé¡å¯è®€)
    regex_pattern   VARCHAR(500) NOT NULL,        -- æ­£å‰‡è¡¨é”å¼

    -- è§£æçµæœæ˜ å°„
    store_code_group    INT,                      -- é–€å¸‚ä»£ç¢¼åœ¨ç¬¬å¹¾å€‹ capture group
    report_code_group   INT,                      -- å ±è¡¨ä»£ç¢¼åœ¨ç¬¬å¹¾å€‹ capture group
    date_group          INT,                      -- æ—¥æœŸåœ¨ç¬¬å¹¾å€‹ capture group

    -- å…ƒè³‡æ–™
    source_system   VARCHAR(50) NOT NULL,         -- LEGACY_N8N, NEW_SYSTEM
    priority        INT DEFAULT 0,                -- å¤šå€‹è¦å‰‡æ™‚çš„å„ªå…ˆé †åº
    is_active       BOOLEAN DEFAULT true,

    -- ç¯„ä¾‹
    example_filename VARCHAR(255),                -- ç¯„ä¾‹æª”å
    example_result   JSONB,                       -- è§£æçµæœç¯„ä¾‹

    created_at      TIMESTAMP DEFAULT NOW()
);

-- ç¯„ä¾‹è³‡æ–™:
-- | pattern_name          | regex_pattern                           | example_filename              |
-- |-----------------------|-----------------------------------------|-------------------------------|
-- | æ¨™æº–æ ¼å¼-é–€å¸‚_å ±è¡¨_æ—¥æœŸ | ^([A-Z_]+)_([A-Z]\d+)_(\d{8})\.xlsx$   | BZ_MED_R001_20240115.xlsx     |
-- | èˆŠæ ¼å¼-å ±è¡¨åç¨±å«é–€å¸‚   | ^(.+)å ±è¡¨_(.+?)_(\d{6})\.xlsx$          | è­·ç†éƒ¨æ¶ˆè€—å ±è¡¨_æ¿æ©‹_202401.xlsx |

-- =====================================================
-- 5. æª”æ¡ˆä¸Šå‚³è¨˜éŒ„è¡¨ (Audit Log)
-- =====================================================
CREATE TABLE file_uploads (
    id              VARCHAR(36) PRIMARY KEY,

    -- ä¾†æºè³‡è¨Š
    source_system   VARCHAR(50) NOT NULL,         -- N8N, NEW_SYSTEM
    original_filename VARCHAR(255) NOT NULL,

    -- è§£æçµæœ
    matched_pattern_id VARCHAR(36) REFERENCES file_patterns(id),
    resolved_store_id  VARCHAR(36) REFERENCES stores(id),
    resolved_report_id VARCHAR(36) REFERENCES reports(id),

    -- ç›®æ¨™è³‡è¨Š
    target_folder_id   VARCHAR(36) REFERENCES drive_folders(id),
    drive_file_id      VARCHAR(100),              -- ä¸Šå‚³å¾Œçš„ Google Drive File ID

    -- ç‹€æ…‹
    status          VARCHAR(20) NOT NULL,         -- PENDING, SUCCESS, FAILED, DUPLICATE
    error_message   TEXT,

    -- æ™‚é–“æˆ³
    uploaded_at     TIMESTAMP DEFAULT NOW(),
    processed_at    TIMESTAMP
);
```

---

## API è¨­è¨ˆ

### æ ¸å¿ƒ API ç«¯é»

```yaml
# =====================================================
# Registry APIs (ä¾› N8N å’Œæ–°ç³»çµ±å…±ç”¨)
# =====================================================

# 1. è§£ææª”å â†’ å–å¾—ç›®æ¨™è³‡æ–™å¤¾ (N8N ä¸»è¦ä½¿ç”¨)
POST /api/registry/resolve-filename
Request:
  {
    "filename": "BZ_MED_R001_20240115.xlsx",
    "source": "N8N"
  }
Response:
  {
    "success": true,
    "data": {
      "store": { "id": "...", "code": "BZ_MED", "name": "æ¿æ©‹å…‰æ¾¤é†«ç¾" },
      "report": { "id": "...", "code": "R001", "name": "è­·ç†éƒ¨æ¶ˆè€—å ±è¡¨" },
      "targetFolder": {
        "id": "...",
        "driveFolderId": "1abc...",
        "drivePath": "/é–€å¸‚å ±è¡¨/æ¿æ©‹å…‰æ¾¤é†«ç¾/ç‡Ÿé‹"
      },
      "suggestedFilename": "R001_è­·ç†éƒ¨æ¶ˆè€—å ±è¡¨_20240115.xlsx"
    }
  }

# 2. ç›´æ¥å–å¾—ç›®æ¨™è³‡æ–™å¤¾ (æ–°ç³»çµ±ä¸»è¦ä½¿ç”¨)
GET /api/registry/folder?storeCode=BZ_MED&reportCode=R001
Response:
  {
    "success": true,
    "data": {
      "driveFolderId": "1abc...",
      "drivePath": "/é–€å¸‚å ±è¡¨/æ¿æ©‹å…‰æ¾¤é†«ç¾/ç‡Ÿé‹",
      "permissions": [
        { "email": "bz_med.manager@company.com", "role": "writer" },
        { "email": "tina@company.com", "role": "reader" }
      ]
    }
  }

# 3. è¨»å†Šæ–°çš„æª”åè§£æè¦å‰‡
POST /api/registry/patterns
Request:
  {
    "patternName": "æ–°ç‰ˆå ±è¡¨æ ¼å¼",
    "regexPattern": "^([A-Z_]+)_([A-Z]\\d+)_(\\d{8})\\.xlsx$",
    "storeCodeGroup": 1,
    "reportCodeGroup": 2,
    "dateGroup": 3,
    "sourceSystem": "NEW_SYSTEM",
    "exampleFilename": "BZ_MED_R001_20240115.xlsx"
  }

# 4. è¨˜éŒ„æª”æ¡ˆä¸Šå‚³ (ç”¨æ–¼ audit trail)
POST /api/registry/uploads
Request:
  {
    "sourceSystem": "N8N",
    "originalFilename": "BZ_MED_R001_20240115.xlsx",
    "resolvedStoreId": "...",
    "resolvedReportId": "...",
    "targetFolderId": "...",
    "driveFileId": "1xyz...",
    "status": "SUCCESS"
  }

# 5. ç¢ºä¿è³‡æ–™å¤¾å­˜åœ¨ (lazy creation)
POST /api/registry/ensure-folder
Request:
  {
    "storeCode": "BZ_MED",
    "reportCode": "R001"  // å¯é¸ï¼Œä¸å¡«å‰‡åªå»ºç«‹é–€å¸‚æ ¹ç›®éŒ„
  }
Response:
  {
    "success": true,
    "data": {
      "created": true,  // æˆ– false å¦‚æœå·²å­˜åœ¨
      "folder": {
        "driveFolderId": "1abc...",
        "drivePath": "/é–€å¸‚å ±è¡¨/æ¿æ©‹å…‰æ¾¤é†«ç¾/ç‡Ÿé‹"
      }
    }
  }
```

---

## N8N å·¥ä½œæµè¨­è¨ˆ

### æ”¹é€ å¾Œçš„ N8N æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        N8N å ±è¡¨åˆ†æ´¾å·¥ä½œæµ                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Trigger    â”‚     â”‚  HTTP Request       â”‚     â”‚  IF                 â”‚
â”‚             â”‚â”€â”€â”€â”€â–¶â”‚                     â”‚â”€â”€â”€â”€â–¶â”‚                     â”‚
â”‚ â€¢ Email     â”‚     â”‚  POST /api/registry â”‚     â”‚  è§£ææˆåŠŸ?          â”‚
â”‚ â€¢ Webhook   â”‚     â”‚  /resolve-filename  â”‚     â”‚                     â”‚
â”‚ â€¢ Schedule  â”‚     â”‚                     â”‚     â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Body:              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  { filename: ... }  â”‚                â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         Yes â”€â”€â”€â”´â”€â”€â”€ No
                                                    â”‚           â”‚
                                                    â–¼           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Google Drive       â”‚     â”‚  Error Handler      â”‚
                    â”‚                     â”‚     â”‚                     â”‚
                    â”‚  Upload to:         â”‚     â”‚  â€¢ è¨˜éŒ„éŒ¯èª¤          â”‚
                    â”‚  {{ targetFolder.   â”‚     â”‚  â€¢ é€šçŸ¥ç®¡ç†å“¡        â”‚
                    â”‚     driveFolderId }}â”‚     â”‚  â€¢ ç§»è‡³å¾…è™•ç†è³‡æ–™å¤¾  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  HTTP Request       â”‚
                    â”‚                     â”‚
                    â”‚  POST /api/registry â”‚
                    â”‚  /uploads           â”‚
                    â”‚                     â”‚
                    â”‚  è¨˜éŒ„ä¸Šå‚³çµæœ        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### N8N ç¯€é»é…ç½®ç¯„ä¾‹

```javascript
// HTTP Request ç¯€é»: è§£ææª”å
{
  "method": "POST",
  "url": "{{ $env.API_BASE_URL }}/api/registry/resolve-filename",
  "headers": {
    "Authorization": "Bearer {{ $env.API_TOKEN }}",
    "Content-Type": "application/json"
  },
  "body": {
    "filename": "{{ $json.attachments[0].filename }}",
    "source": "N8N"
  }
}

// Google Drive ç¯€é»: ä¸Šå‚³æª”æ¡ˆ
{
  "operation": "upload",
  "folderId": "{{ $json.data.targetFolder.driveFolderId }}",
  "fileName": "{{ $json.data.suggestedFilename }}",
  "binaryData": true,
  "binaryPropertyName": "attachment_0"
}
```

---

## æ–°ç³»çµ±æ•´åˆæ–¹å¼

### TypeScript æœå‹™å±¤

```typescript
// backend/src/services/report-upload.service.ts

import { RegistryService } from './registry.service';
import { GoogleDriveService } from '../integrations/google-drive/google-drive.service';

export class ReportUploadService {
  constructor(
    private registry: RegistryService,
    private gdrive: GoogleDriveService
  ) {}

  /**
   * æ–°ç³»çµ±ä¸Šå‚³å ±è¡¨çš„çµ±ä¸€å…¥å£
   */
  async uploadReport(params: {
    storeCode: string;
    reportCode: string;
    fileBuffer: Buffer;
    filename: string;
    generatedBy: string;
  }): Promise<UploadResult> {

    // 1. å¾ Registry å–å¾—ç›®æ¨™è³‡æ–™å¤¾
    const folder = await this.registry.getFolder({
      storeCode: params.storeCode,
      reportCode: params.reportCode
    });

    // 2. å¦‚æœè³‡æ–™å¤¾ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹
    if (!folder) {
      await this.registry.ensureFolder({
        storeCode: params.storeCode,
        reportCode: params.reportCode
      });
    }

    // 3. ä¸Šå‚³è‡³ Google Drive
    const driveFile = await this.gdrive.uploadFile({
      folderId: folder.driveFolderId,
      filename: this.formatFilename(params),
      content: params.fileBuffer,
      mimeType: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    // 4. è¨˜éŒ„ä¸Šå‚³
    await this.registry.recordUpload({
      sourceSystem: 'NEW_SYSTEM',
      originalFilename: params.filename,
      resolvedStoreCode: params.storeCode,
      resolvedReportCode: params.reportCode,
      driveFileId: driveFile.id,
      status: 'SUCCESS'
    });

    return {
      success: true,
      driveFileId: driveFile.id,
      driveUrl: driveFile.webViewLink
    };
  }

  private formatFilename(params: {
    reportCode: string;
    filename: string;
  }): string {
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const reportName = this.registry.getReportName(params.reportCode);
    return `${params.reportCode}_${reportName}_${date}.xlsx`;
  }
}
```

---

## è³‡æ–™å¤¾çµæ§‹è¦ç¯„

### Google Drive æ¨™æº–çµæ§‹

```
ğŸ“ N-Report å ±è¡¨ç³»çµ± (Shared Drive)
â”‚
â”œâ”€â”€ ğŸ“ é–€å¸‚å ±è¡¨
â”‚   â”œâ”€â”€ ğŸ“ æ¿æ©‹å…‰æ¾¤é†«ç¾ (BZ_MED)
â”‚   â”‚   â”œâ”€â”€ ğŸ“ ç‡Ÿé‹
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ R001_è­·ç†éƒ¨æ¶ˆè€—å ±è¡¨_20240115.xlsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ R006_é€²éŠ·è²¨æ˜ç´°_20240115.xlsx
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ ğŸ“ äººè³‡
â”‚   â”‚   â”‚   â”œâ”€â”€ ğŸ“„ R003a_æ–°é€²äººå“¡åå–®_20240115.xlsx
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ ğŸ“ è²¡å‹™
â”‚   â”‚   â””â”€â”€ ğŸ“ å…¶ä»–
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ å¿ å­å…‰æ¾¤ (ZX_GZ)
â”‚   â”‚   â””â”€â”€ (åŒä¸Šçµæ§‹)
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ ... (å…¶ä»–é–€å¸‚)
â”‚
â”œâ”€â”€ ğŸ“ å€åŸŸå ±è¡¨
â”‚   â”œâ”€â”€ ğŸ“ Tina ç®¡ç†å€åŸŸ
â”‚   â”œâ”€â”€ ğŸ“ å«šçˆ ç®¡ç†å€åŸŸ
â”‚   â””â”€â”€ ğŸ“ Nana ç®¡ç†å€åŸŸ
â”‚
â””â”€â”€ ğŸ“ _ç³»çµ±è³‡æ–™å¤¾
    â”œâ”€â”€ ğŸ“ å¾…è™•ç† (è§£æå¤±æ•—çš„æª”æ¡ˆ)
    â”œâ”€â”€ ğŸ“ æ­¸æª” (èˆŠå ±è¡¨å‚™ä»½)
    â””â”€â”€ ğŸ“ ç¯„æœ¬
```

### æª”æ¡ˆå‘½åè¦ç¯„

```
æ¨™æº–æ ¼å¼: {å ±è¡¨ä»£ç¢¼}_{å ±è¡¨åç¨±}_{æ—¥æœŸ}.xlsx

ç¯„ä¾‹:
âœ… R001_è­·ç†éƒ¨æ¶ˆè€—å ±è¡¨_20240115.xlsx
âœ… R003a_æ–°é€²äººå“¡åå–®_20240115.xlsx
âœ… R012_é›»éŠ·çé‡‘ç¶“ç‡Ÿå®¢è¡¨_202401.xlsx (æœˆå ±è¡¨)

âŒ è­·ç†éƒ¨å ±è¡¨.xlsx (ç¼ºå°‘ä»£ç¢¼å’Œæ—¥æœŸ)
âŒ report_20240115.xlsx (ç¼ºå°‘å ±è¡¨ä»£ç¢¼)
```

---

## é·ç§»ç­–ç•¥

### Phase 1: å»ºç«‹ Registry (ç¬¬ 1-2 é€±)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å»ºç«‹è³‡æ–™åº«è¡¨çµæ§‹                                             â”‚
â”‚  2. åŒ¯å…¥ç¾æœ‰é–€å¸‚è³‡æ–™ (32 é–“)                                     â”‚
â”‚  3. åŒ¯å…¥ç¾æœ‰å ±è¡¨å®šç¾© (28 ä»½)                                     â”‚
â”‚  4. æƒæç¾æœ‰ Google Drive çµæ§‹ï¼Œå»ºç«‹ folder æ˜ å°„                 â”‚
â”‚  5. åˆ†æç¾æœ‰ N8N æª”åè¦å‰‡ï¼Œè½‰æ›ç‚º patterns è¡¨                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 2: N8N æ”¹é€  (ç¬¬ 3-4 é€±)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å»ºç«‹ /api/registry/resolve-filename API                     â”‚
â”‚  2. ä¿®æ”¹ N8N å·¥ä½œæµï¼Œæ”¹ç”¨ API è§£ææª”å                           â”‚
â”‚  3. å¹³è¡Œé‹è¡Œï¼šæ–°èˆŠé‚è¼¯ä¸¦è¡Œï¼Œæ¯”å°çµæœ                              â”‚
â”‚  4. ç¢ºèªä¸€è‡´å¾Œï¼Œå®Œå…¨åˆ‡æ›è‡³æ–°æµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Phase 3: æ–°ç³»çµ±æ•´åˆ (ç¬¬ 5-6 é€±)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ–°ç³»çµ±ä½¿ç”¨ RegistryService å–å¾—ç›®æ¨™è³‡æ–™å¤¾                    â”‚
â”‚  2. çµ±ä¸€æª”æ¡ˆå‘½åè¦å‰‡                                             â”‚
â”‚  3. å»ºç«‹ audit trail å®Œæ•´è¨˜éŒ„                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¶­è­·å„ªå‹¢

### 1. å–®ä¸€çœŸç›¸ä¾†æº (Single Source of Truth)

```
ä¿®æ”¹é–€å¸‚/å ±è¡¨è³‡è¨Š â†’ åªéœ€ä¿®æ”¹ Registry â†’ N8N å’Œæ–°ç³»çµ±è‡ªå‹•åŒæ­¥
```

### 2. æª”åè¦å‰‡å¯è¦–åŒ–ç®¡ç†

```
åœ¨ä¸­æ§å°ç®¡ç† file_patterns è¡¨ â†’ ä¸éœ€ä¿®æ”¹ N8N ç¯€é»
```

### 3. å®Œæ•´è¿½è¹¤è¨˜éŒ„

```
file_uploads è¡¨è¨˜éŒ„æ‰€æœ‰ä¸Šå‚³ â†’ å¯è¿½æº¯ä»»ä½•æª”æ¡ˆçš„ä¾†æºå’Œè™•ç†éç¨‹
```

### 4. è³‡æ–™å¤¾ ID é›†ä¸­ç®¡ç†

```
drive_folders è¡¨å¿«å–æ‰€æœ‰è³‡æ–™å¤¾ ID â†’ é¿å…é‡è¤‡å‘¼å« Google API
```

### 5. æ–°å¢é–€å¸‚/å ±è¡¨æµç¨‹

```
1. åœ¨ä¸­æ§å°æ–°å¢é–€å¸‚/å ±è¡¨
2. ç³»çµ±è‡ªå‹•åœ¨ Google Drive å»ºç«‹å°æ‡‰è³‡æ–™å¤¾
3. ç³»çµ±è‡ªå‹•æ›´æ–° drive_folders è¡¨
4. N8N å’Œæ–°ç³»çµ±ç«‹å³å¯ç”¨ (ç„¡éœ€ä¿®æ”¹å·¥ä½œæµ)
```

---

## é–‹ç™¼æª¢æŸ¥æ¸…å–®

### Backend é–‹ç™¼é …ç›®

- [ ] Prisma Schema æ›´æ–° (æ–°å¢ drive_folders, file_patterns, file_uploads)
- [ ] RegistryService å¯¦ä½œ
- [ ] Registry API endpoints
- [ ] Google Drive Service æ•´åˆ
- [ ] è³‡æ–™é·ç§»è…³æœ¬

### N8N ä¿®æ”¹é …ç›®

- [ ] æ–°å¢ HTTP Request ç¯€é» (å‘¼å« resolve-filename)
- [ ] ä¿®æ”¹ Google Drive ç¯€é» (ä½¿ç”¨å‹•æ…‹ folder ID)
- [ ] æ–°å¢éŒ¯èª¤è™•ç†æµç¨‹
- [ ] æ–°å¢ä¸Šå‚³è¨˜éŒ„ç¯€é»

### Frontend ä¿®æ”¹é …ç›®

- [ ] æ–°å¢ file_patterns ç®¡ç†ä»‹é¢
- [ ] æ–°å¢ drive_folders æŸ¥çœ‹ä»‹é¢
- [ ] æ–°å¢ file_uploads æ—¥èªŒæŸ¥çœ‹ä»‹é¢
- [ ] æ•´åˆæ–°å±•åº—æµç¨‹ (è‡ªå‹•å»ºç«‹ Drive è³‡æ–™å¤¾)
