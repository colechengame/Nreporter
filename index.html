<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-Report 權限中控台 (V3 Email 維護版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F4C81',
                        secondary: '#F5F7FA',
                        ai: '#8B5CF6',
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        
        .checkbox-card input:checked + div {
            border-color: #0F4C81;
            background-color: #ebf5ff;
            color: #0F4C81;
        }
        .checkbox-card input:checked + div .check-icon {
            opacity: 1;
        }

        /* 篩選按鈕樣式 */
        .store-filter-btn {
            background: white;
            border-color: #e5e7eb;
            color: #6b7280;
        }
        .store-filter-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }
        .store-filter-btn.active {
            background: #0F4C81;
            border-color: #0F4C81;
            color: white;
        }
        .store-filter-btn.active span {
            background: rgba(255,255,255,0.2) !important;
            color: white !important;
        }

        /* === Mobile-only RWD === */
        @media (max-width: 639px) {
            body { padding-bottom: 3.5rem; }
            /* Mobile compact table cards */
            .mobile-compact thead { display: none; }
            .mobile-compact tbody { display: flex; flex-direction: column; }
            .mobile-compact tr {
                display: flex; flex-wrap: wrap; align-items: center;
                padding: 8px 12px; border-bottom: 1px solid #f3f4f6;
                gap: 0;
            }
            .mobile-compact td {
                display: block; padding: 2px 0 !important;
                border: none !important; background: transparent !important;
                width: 100% !important; text-align: left !important;
            }
            .mobile-compact td:nth-child(1) { order: 1; width: 100% !important; }
            .mobile-compact td:nth-child(2) { order: 2; width: 100% !important; }
            .mobile-compact td:nth-child(3) { order: 4; width: 100% !important; }
            .mobile-compact td:nth-child(4) { order: 3; width: auto !important; }
            /* Bottom nav */
            .m-bnav { box-shadow: 0 -2px 10px rgba(0,0,0,0.06); }
            .m-bnav-active { color: #0F4C81; font-weight: 700; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">

    <!-- 頂部導航 -->
    <nav class="bg-primary text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-12 sm:h-16">
                <div class="flex items-center">
                    <span class="font-bold text-sm sm:text-2xl"><i class="fa-solid fa-shield-halved mr-1 sm:mr-2"></i><span class="hidden sm:inline">N-Report 權限中控台</span><span class="sm:hidden">N-Report</span></span>
                    <span class="ml-2 sm:ml-4 px-2 py-0.5 rounded text-xs bg-blue-800 text-blue-200 border border-blue-700 hidden sm:inline-block">Unified Access Control</span>
                    <!-- 體系視角選擇器 -->
                    <div class="ml-2 sm:ml-4 relative">
                        <button onclick="toggleSystemDropdown()" id="system-dropdown-btn" class="flex items-center px-2 py-1 sm:px-3 sm:py-1.5 rounded-lg bg-white/10 hover:bg-white/20 border border-white/20 transition text-xs sm:text-sm">
                            <i id="system-icon" class="fa-solid fa-globe mr-1 sm:mr-2"></i>
                            <span id="system-name" class="hidden sm:inline">全部體系</span>
                            <i class="fa-solid fa-chevron-down ml-1 sm:ml-2 text-xs"></i>
                        </button>
                        <div id="system-dropdown" class="hidden absolute left-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-50">
                            <button onclick="setBusinessSystem('all')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center system-option" data-system="all">
                                <i class="fa-solid fa-globe w-5 text-slate-600"></i>
                                <span class="ml-2">全部體系</span>
                                <i class="fa-solid fa-check ml-auto text-primary hidden"></i>
                            </button>
                            <button onclick="setBusinessSystem('guangze')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center system-option" data-system="guangze">
                                <i class="fa-solid fa-star w-5 text-yellow-500"></i>
                                <span class="ml-2">星辰集團</span>
                                <i class="fa-solid fa-check ml-auto text-primary hidden"></i>
                            </button>
                            <button onclick="setBusinessSystem('tcm')" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center system-option" data-system="tcm">
                                <i class="fa-solid fa-leaf w-5 text-green-600"></i>
                                <span class="ml-2">中醫體系</span>
                                <i class="fa-solid fa-check ml-auto text-primary hidden"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4 text-sm">
                    <div class="hidden md:flex items-center space-x-3 mr-4">
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-syringe mr-1.5 text-pink-300"></i>醫美 <span class="font-bold ml-1">20</span>
                        </span>
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-spa mr-1.5 text-amber-300"></i>岩盤浴 <span class="font-bold ml-1">6</span>
                        </span>
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-file-lines mr-1.5 text-cyan-300"></i>報表 <span class="font-bold ml-1">28</span>
                        </span>
                    </div>

                    <button onclick="openAIModal()" class="bg-gradient-to-r from-violet-600 to-fuchsia-600 hover:from-violet-500 hover:to-fuchsia-500 text-white px-4 py-2 rounded-full font-bold shadow-md transition transform hover:scale-105 hidden sm:flex items-center border border-white/20">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> AI 助手
                    </button>
                    <!-- Mobile: compact AI button -->
                    <button onclick="openAIModal()" class="sm:hidden bg-violet-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-xs">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                    </button>

                    <span class="bg-blue-800 px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-[10px] sm:text-sm"><i class="fa-solid fa-user-tie mr-1"></i><span class="hidden sm:inline"> 營業部主管</span></span>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要內容 -->
    <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8 py-2 sm:py-8">

        <!-- 頁籤切換 (desktop) -->
        <div class="mb-6 border-b border-gray-200 hidden sm:block">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('store')" id="tab-store" class="border-primary text-primary whitespace-nowrap py-4 px-1 border-b-2 font-bold text-base flex items-center transition-colors">
                    <i class="fa-solid fa-store mr-2"></i> 門市與細部權限 (Store & Granular)
                </button>
                <button onclick="switchTab('template')" id="tab-template" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-bold text-base flex items-center transition-colors">
                    <i class="fa-solid fa-clipboard-list mr-2"></i> 報表組合 (Templates)
                </button>
                <button onclick="switchTab('settings')" id="tab-settings" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-bold text-base flex items-center transition-colors">
                    <i class="fa-solid fa-screwdriver-wrench mr-2"></i> 系統設定
                </button>
            </nav>
        </div>

        <!-- VIEW 1: 門市管理 (Store View) -->
        <div id="view-store" class="block animate-fade-in">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-3 py-2 sm:px-6 sm:py-5 bg-gray-50 border-b border-gray-200">
                    <!-- Desktop header -->
                    <div class="hidden sm:flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl leading-6 font-bold text-gray-900">門市人員配置與授權</h3>
                            <p class="mt-1 max-w-2xl text-base text-gray-500">設定門市角色信箱 (Role Email) 與負責人員。</p>
                        </div>
                        <button onclick="openModal('new-store')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-base shadow transition flex items-center">
                            <i class="fa-solid fa-plus mr-2"></i> 新展店設定
                        </button>
                    </div>
                    <!-- Mobile: compact search + filter row -->
                    <div class="flex gap-2 items-center sm:hidden mb-2">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" id="store-search-m" placeholder="搜尋門市..."
                                   class="w-full pl-8 pr-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-primary focus:border-primary"
                                   oninput="document.getElementById('store-search').value=this.value;filterStores()">
                        </div>
                        <button onclick="openModal('new-store')" class="bg-green-600 text-white px-2 py-1.5 rounded text-xs flex-shrink-0">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <div class="flex gap-1 sm:hidden overflow-x-auto pb-1">
                        <button onclick="setStoreFilter('all')" id="filter-all-m" class="store-filter-btn active px-2.5 py-1 text-[10px] rounded-full border transition whitespace-nowrap">
                            全部<span class="ml-0.5 bg-gray-200 text-gray-600 px-1 rounded" id="count-all-m">0</span>
                        </button>
                        <button onclick="setStoreFilter('med')" id="filter-med-m" class="store-filter-btn px-2.5 py-1 text-[10px] rounded-full border transition whitespace-nowrap">
                            <i class="fa-solid fa-syringe mr-0.5 text-pink-500"></i>醫美<span class="ml-0.5 bg-pink-100 text-pink-600 px-1 rounded" id="count-med-m">0</span>
                        </button>
                        <button onclick="setStoreFilter('spa')" id="filter-spa-m" class="store-filter-btn px-2.5 py-1 text-[10px] rounded-full border transition whitespace-nowrap">
                            <i class="fa-solid fa-spa mr-0.5 text-amber-500"></i>養生<span class="ml-0.5 bg-amber-100 text-amber-600 px-1 rounded" id="count-spa-m">0</span>
                        </button>
                        <button onclick="setStoreFilter('other')" id="filter-other-m" class="store-filter-btn px-2.5 py-1 text-[10px] rounded-full border transition whitespace-nowrap">
                            其他<span class="ml-0.5 bg-gray-200 text-gray-600 px-1 rounded" id="count-other-m">0</span>
                        </button>
                    </div>
                    <!-- Desktop search + filter -->
                    <div class="hidden sm:flex flex-col sm:flex-row gap-3">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="store-search" placeholder="搜尋門市名稱、代碼、店經理..."
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-base focus:ring-primary focus:border-primary"
                                   oninput="filterStores()">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="setStoreFilter('all')" id="filter-all" class="store-filter-btn active px-4 py-2 text-sm rounded-lg border transition">
                                全部 <span class="ml-1 text-xs bg-gray-200 text-gray-600 px-1.5 rounded" id="count-all">0</span>
                            </button>
                            <button onclick="setStoreFilter('med')" id="filter-med" class="store-filter-btn px-4 py-2 text-sm rounded-lg border transition">
                                <i class="fa-solid fa-syringe mr-1 text-pink-500"></i>醫美 <span class="ml-1 text-xs bg-pink-100 text-pink-600 px-1.5 rounded" id="count-med">0</span>
                            </button>
                            <button onclick="setStoreFilter('spa')" id="filter-spa" class="store-filter-btn px-4 py-2 text-sm rounded-lg border transition">
                                <i class="fa-solid fa-spa mr-1 text-amber-500"></i>岩盤浴 <span class="ml-1 text-xs bg-amber-100 text-amber-600 px-1.5 rounded" id="count-spa">0</span>
                            </button>
                            <button onclick="setStoreFilter('other')" id="filter-other" class="store-filter-btn px-4 py-2 text-sm rounded-lg border transition">
                                其他 <span class="ml-1 text-xs bg-gray-200 text-gray-600 px-1.5 rounded" id="count-other">0</span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- Desktop table -->
                <div class="border-t border-gray-200 hidden sm:block">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider w-1/5">門市資訊</th>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider w-1/3">主要店經理 & Role Email</th>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider w-1/3">其他授權人員 (Granular)</th>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider w-1/10 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="store-list">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
                <!-- Mobile compact list -->
                <div id="store-list-mobile" class="sm:hidden divide-y divide-gray-100">
                    <!-- JS Generated -->
                </div>
            </div>
        </div>


        <!-- VIEW 3: 報表組合管理 (Template View) -->
        <div id="view-template" class="hidden animate-fade-in">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-3 py-2 sm:px-6 sm:py-5 bg-gray-50 border-b border-gray-200">
                    <!-- Desktop header -->
                    <div class="hidden sm:flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-xl leading-6 font-bold text-gray-900">報表組合管理</h3>
                            <p class="mt-1 max-w-2xl text-base text-gray-500">預先定義報表組合，指派權限時可快速套用。</p>
                        </div>
                        <button onclick="openModal('new-template')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-base shadow transition flex items-center">
                            <i class="fa-solid fa-plus mr-2"></i> 新增報表組合
                        </button>
                    </div>
                    <!-- Mobile header -->
                    <div class="flex gap-2 items-center sm:hidden">
                        <div class="relative flex-1">
                            <i class="fa-solid fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                            <input type="text" id="template-search-m" placeholder="搜尋組合..."
                                   class="w-full pl-8 pr-2 py-1.5 border border-gray-300 rounded-lg text-xs focus:ring-indigo-500 focus:border-indigo-500"
                                   oninput="document.getElementById('template-search').value=this.value;filterTemplates()">
                        </div>
                        <button onclick="openModal('new-template')" class="bg-indigo-600 text-white px-2 py-1.5 rounded text-xs flex-shrink-0">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>
                    <!-- Desktop search -->
                    <div class="relative max-w-md hidden sm:block">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="template-search" placeholder="搜尋組合名稱..."
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-base focus:ring-indigo-500 focus:border-indigo-500"
                               oninput="filterTemplates()">
                    </div>
                </div>
                <!-- Desktop table -->
                <div class="border-t border-gray-200 hidden sm:block">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider w-1/5">組合名稱</th>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider w-1/5">適用說明</th>
                                <th scope="col" class="px-6 py-3 text-left text-sm font-bold text-gray-500 uppercase tracking-wider">包含報表</th>
                                <th scope="col" class="px-6 py-3 text-right text-sm font-bold text-gray-500 uppercase tracking-wider w-24">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="template-list">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
                <!-- Mobile compact list -->
                <div id="template-list-mobile" class="sm:hidden divide-y divide-gray-100">
                    <!-- JS Generated -->
                </div>
            </div>
        </div>


        <!-- VIEW 5: 系統設定 (Settings View) -->
        <div id="view-settings" class="hidden animate-fade-in">
            <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                <div class="px-3 py-3 sm:px-6 sm:py-5 bg-gradient-to-r from-slate-700 to-slate-800 text-white">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-base sm:text-xl leading-6 font-bold flex items-center">
                                <i class="fa-solid fa-screwdriver-wrench mr-1 sm:mr-2"></i>系統設定
                            </h3>
                            <p class="mt-0.5 sm:mt-1 max-w-2xl text-xs sm:text-sm text-slate-300 hidden sm:block">新展店設定、報表管理、Google Drive 整合</p>
                        </div>
                        <button onclick="openSettingsInNewTab()" class="bg-white/20 hover:bg-white/30 text-white px-2 py-1.5 sm:px-4 sm:py-2 rounded text-xs sm:text-sm transition flex items-center">
                            <i class="fa-solid fa-up-right-from-square sm:mr-2"></i><span class="hidden sm:inline"> 新視窗開啟</span>
                        </button>
                    </div>
                </div>
                <!-- 內嵌子頁籤 -->
                <div class="border-b border-gray-200 bg-gray-50">
                    <nav class="flex px-2 sm:px-4" aria-label="Settings Tabs">
                        <button onclick="switchSettingsTab('new-store')" id="settings-tab-new-store" class="settings-tab-btn active px-2.5 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-bold border-b-2 border-primary text-primary">
                            <i class="fa-solid fa-store mr-1"></i> 新展店
                        </button>
                        <button onclick="switchSettingsTab('reports')" id="settings-tab-reports" class="settings-tab-btn px-2.5 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fa-solid fa-file-lines mr-1"></i> 報表
                        </button>
                        <button onclick="switchSettingsTab('gdrive')" id="settings-tab-gdrive" class="settings-tab-btn px-2.5 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-bold border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                            <i class="fa-brands fa-google-drive mr-1"></i> Drive
                        </button>
                    </nav>
                </div>

                <!-- Settings: 新展店 -->
                <div id="settings-new-store" class="settings-content p-3 sm:p-6">
                    <div class="max-w-3xl mx-auto">
                        <!-- Step Indicator -->
                        <div class="flex justify-between mb-4 sm:mb-8">
                            <div class="flex-1 text-center">
                                <div id="new-store-step-1" class="w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2">1</div>
                                <span class="text-[10px] sm:text-xs text-gray-600">基本資料</span>
                            </div>
                            <div class="flex-1 text-center">
                                <div id="new-store-step-2" class="w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2">2</div>
                                <span class="text-[10px] sm:text-xs text-gray-400">人員指派</span>
                            </div>
                            <div class="flex-1 text-center">
                                <div id="new-store-step-3" class="w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2">3</div>
                                <span class="text-[10px] sm:text-xs text-gray-400">Drive</span>
                            </div>
                            <div class="flex-1 text-center">
                                <div id="new-store-step-4" class="w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2">4</div>
                                <span class="text-[10px] sm:text-xs text-gray-400">確認</span>
                            </div>
                        </div>

                        <!-- Step 1 Content -->
                        <div id="new-store-content-1" class="new-store-step">
                            <h4 class="text-lg font-bold text-gray-800 mb-4"><i class="fa-solid fa-building text-primary mr-2"></i>門市基本資料</h4>

                            <!-- Store Type -->
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-700 mb-3">門市類型 <span class="text-red-500">*</span></label>
                                <div class="grid grid-cols-3 gap-2 sm:gap-4">
                                    <label class="cursor-pointer">
                                        <input type="radio" name="new-store-type" value="MED" class="hidden peer" checked>
                                        <div class="border-2 border-gray-200 rounded-xl p-2 sm:p-4 text-center peer-checked:border-primary peer-checked:bg-blue-50 transition">
                                            <i class="fa-solid fa-syringe text-lg sm:text-2xl text-pink-500 mb-1 sm:mb-2"></i>
                                            <div class="font-bold text-gray-800 text-xs sm:text-base">醫美</div>
                                            <div class="text-[10px] sm:text-xs text-gray-500 hidden sm:block">光澤/彤顏</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="new-store-type" value="SPA" class="hidden peer">
                                        <div class="border-2 border-gray-200 rounded-xl p-2 sm:p-4 text-center peer-checked:border-primary peer-checked:bg-blue-50 transition">
                                            <i class="fa-solid fa-spa text-lg sm:text-2xl text-amber-500 mb-1 sm:mb-2"></i>
                                            <div class="font-bold text-gray-800 text-xs sm:text-base">岩盤浴</div>
                                            <div class="text-[10px] sm:text-xs text-gray-500 hidden sm:block">SPA 館</div>
                                        </div>
                                    </label>
                                    <label class="cursor-pointer">
                                        <input type="radio" name="new-store-type" value="OTHER" class="hidden peer">
                                        <div class="border-2 border-gray-200 rounded-xl p-2 sm:p-4 text-center peer-checked:border-primary peer-checked:bg-blue-50 transition">
                                            <i class="fa-solid fa-building text-lg sm:text-2xl text-gray-500 mb-1 sm:mb-2"></i>
                                            <div class="font-bold text-gray-800 text-xs sm:text-base">其他</div>
                                            <div class="text-[10px] sm:text-xs text-gray-500 hidden sm:block">辦公室/總部</div>
                                        </div>
                                    </label>
                                </div>
                            </div>

                            <!-- Store Info -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4">
                                <div>
                                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1 sm:mb-2">門市代碼 <span class="text-red-500">*</span></label>
                                    <input type="text" id="wizard-store-code" placeholder="例如: BZ_MED" oninput="wizardAutoEmail()"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-1.5 sm:px-4 sm:py-2 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                    <p class="text-[10px] sm:text-xs text-gray-500 mt-1">格式: 地區_類型</p>
                                </div>
                                <div>
                                    <label class="block text-xs sm:text-sm font-bold text-gray-700 mb-1 sm:mb-2">門市名稱 <span class="text-red-500">*</span></label>
                                    <input type="text" id="wizard-store-name" placeholder="例如: 板橋光澤醫美"
                                           class="w-full border border-gray-300 rounded-lg px-3 py-1.5 sm:px-4 sm:py-2 text-sm focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                </div>
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-bold text-gray-700 mb-2">角色 Email (Role Email) <span class="text-red-500">*</span></label>
                                <input type="email" id="wizard-store-email" placeholder="自動產生..."
                                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary/20 focus:border-primary">
                                <p class="text-xs text-gray-500 mt-1"><i class="fa-solid fa-circle-info mr-1 text-blue-500"></i>此 Email 將用於 Google Drive 權限授權</p>
                            </div>
                        </div>

                        <!-- Step 2 Content -->
                        <div id="new-store-content-2" class="new-store-step hidden">
                            <h4 class="text-lg font-bold text-gray-800 mb-4"><i class="fa-solid fa-user-tie text-primary mr-2"></i>人員指派</h4>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p class="text-sm text-blue-700"><i class="fa-solid fa-lightbulb mr-2"></i>您可以稍後再指派店經理</p>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-bold text-gray-700 mb-2">指派主要店經理</label>
                                <select id="wizard-store-manager" class="w-full border border-gray-300 rounded-lg px-4 py-2">
                                    <option value="">-- 暫不指派 --</option>
                                </select>
                            </div>
                        </div>

                        <!-- Step 3 Content -->
                        <div id="new-store-content-3" class="new-store-step hidden">
                            <h4 class="text-lg font-bold text-gray-800 mb-4"><i class="fa-brands fa-google-drive text-blue-500 mr-2"></i>Google Drive 設定</h4>
                            <div class="space-y-3">
                                <label class="flex items-start p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" id="wizard-gdrive-folder" checked class="mt-1 w-5 h-5 text-primary rounded">
                                    <div class="ml-4">
                                        <div class="font-bold text-gray-800"><i class="fa-solid fa-folder-plus text-blue-500 mr-2"></i>自動建立 Google Drive 資料夾</div>
                                        <p class="text-sm text-gray-500">在「門市報表」下建立此門市的專屬資料夾</p>
                                    </div>
                                </label>
                                <label class="flex items-start p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" id="wizard-gdrive-access" checked class="mt-1 w-5 h-5 text-primary rounded">
                                    <div class="ml-4">
                                        <div class="font-bold text-gray-800"><i class="fa-solid fa-share-nodes text-green-500 mr-2"></i>自動授權 Role Email</div>
                                        <p class="text-sm text-gray-500">將 Role Email 設為資料夾「編輯者」</p>
                                    </div>
                                </label>
                                <label class="flex items-start p-4 border border-gray-200 rounded-xl cursor-pointer hover:bg-gray-50">
                                    <input type="checkbox" id="wizard-n8n-notify" checked class="mt-1 w-5 h-5 text-primary rounded">
                                    <div class="ml-4">
                                        <div class="font-bold text-gray-800"><i class="fa-solid fa-bolt text-orange-500 mr-2"></i>通知 n8n 更新分派規則</div>
                                        <p class="text-sm text-gray-500">觸發工作流將新門市加入報表分派名單</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Step 4 Content -->
                        <div id="new-store-content-4" class="new-store-step hidden">
                            <h4 class="text-lg font-bold text-gray-800 mb-4"><i class="fa-solid fa-clipboard-check text-primary mr-2"></i>確認門市資料</h4>
                            <div class="bg-gray-50 rounded-xl p-3 sm:p-6">
                                <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                                    <div>
                                        <dt class="text-sm text-gray-500">門市類型</dt>
                                        <dd id="wizard-confirm-type" class="font-bold text-gray-800">-</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm text-gray-500">門市代碼</dt>
                                        <dd id="wizard-confirm-code" class="font-mono font-bold text-gray-800">-</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm text-gray-500">門市名稱</dt>
                                        <dd id="wizard-confirm-name" class="font-bold text-gray-800">-</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm text-gray-500">Role Email</dt>
                                        <dd id="wizard-confirm-email" class="font-mono text-sm text-gray-800">-</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm text-gray-500">店經理</dt>
                                        <dd id="wizard-confirm-manager" class="font-bold text-gray-800">-</dd>
                                    </div>
                                    <div>
                                        <dt class="text-sm text-gray-500">Drive 操作</dt>
                                        <dd id="wizard-confirm-gdrive" class="text-sm text-gray-800">-</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>

                        <!-- Navigation -->
                        <div class="flex justify-between mt-8 pt-6 border-t border-gray-200">
                            <button type="button" id="wizard-prev" onclick="wizardPrev()" class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium hidden">
                                <i class="fa-solid fa-arrow-left mr-2"></i>上一步
                            </button>
                            <div class="flex-1"></div>
                            <button type="button" id="wizard-next" onclick="wizardNext()" class="px-6 py-2 bg-primary hover:bg-blue-700 text-white font-bold rounded-lg shadow transition">
                                下一步<i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                            <button type="button" id="wizard-submit" onclick="wizardSubmit()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow transition hidden">
                                <i class="fa-solid fa-check mr-2"></i>建立門市
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings: 報表管理 -->
                <div id="settings-reports" class="settings-content hidden p-3 sm:p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-bold text-gray-800"><i class="fa-solid fa-file-lines text-primary mr-2"></i>報表管理</h4>
                        <button onclick="openModal('new-report')" class="bg-primary hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow transition">
                            <i class="fa-solid fa-plus mr-2"></i>新增報表
                        </button>
                    </div>
                    <!-- Filter -->
                    <div class="flex gap-2 mb-4 flex-wrap">
                        <button onclick="setReportMgmtFilter('all')" class="report-mgmt-filter active px-3 py-1.5 text-xs rounded-lg border bg-primary text-white">全部</button>
                        <button onclick="setReportMgmtFilter('營運')" class="report-mgmt-filter px-3 py-1.5 text-xs rounded-lg border bg-white text-gray-600 hover:bg-gray-50">營運</button>
                        <button onclick="setReportMgmtFilter('人資')" class="report-mgmt-filter px-3 py-1.5 text-xs rounded-lg border bg-white text-gray-600 hover:bg-gray-50">人資</button>
                        <button onclick="setReportMgmtFilter('財務')" class="report-mgmt-filter px-3 py-1.5 text-xs rounded-lg border bg-white text-gray-600 hover:bg-gray-50">財務</button>
                        <button onclick="setReportMgmtFilter('行銷')" class="report-mgmt-filter px-3 py-1.5 text-xs rounded-lg border bg-white text-gray-600 hover:bg-gray-50">行銷</button>
                        <button onclick="setReportMgmtFilter('會員')" class="report-mgmt-filter px-3 py-1.5 text-xs rounded-lg border bg-white text-gray-600 hover:bg-gray-50">會員</button>
                        <button onclick="setReportMgmtFilter('系統')" class="report-mgmt-filter px-3 py-1.5 text-xs rounded-lg border bg-white text-gray-600 hover:bg-gray-50">系統</button>
                    </div>
                    <!-- Report List -->
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left font-bold text-gray-500">代碼</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-500">報表名稱</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-500">分類</th>
                                    <th class="px-4 py-3 text-left font-bold text-gray-500">狀態</th>
                                    <th class="px-4 py-3 text-right font-bold text-gray-500">操作</th>
                                </tr>
                            </thead>
                            <tbody id="report-mgmt-list" class="divide-y divide-gray-200">
                                <!-- JS Generated -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings: Google Drive -->
                <div id="settings-gdrive" class="settings-content hidden p-3 sm:p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6">
                        <!-- Main Panel -->
                        <div class="sm:col-span-2">
                            <h4 class="text-lg font-bold text-gray-800 mb-4"><i class="fa-brands fa-google-drive text-blue-500 mr-2"></i>同步狀態</h4>
                            <!-- Stats -->
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-4 sm:mb-6">
                                <div class="bg-green-50 rounded-xl p-2 sm:p-4 text-center">
                                    <div class="text-lg sm:text-2xl font-bold text-green-600" id="gdrive-sync-ok">28</div>
                                    <div class="text-[10px] sm:text-xs text-green-700">同步成功</div>
                                </div>
                                <div class="bg-yellow-50 rounded-xl p-2 sm:p-4 text-center">
                                    <div class="text-lg sm:text-2xl font-bold text-yellow-600" id="gdrive-sync-pending">3</div>
                                    <div class="text-[10px] sm:text-xs text-yellow-700">待同步</div>
                                </div>
                                <div class="bg-red-50 rounded-xl p-2 sm:p-4 text-center">
                                    <div class="text-lg sm:text-2xl font-bold text-red-600" id="gdrive-sync-error">1</div>
                                    <div class="text-[10px] sm:text-xs text-red-700">失敗</div>
                                </div>
                                <div class="bg-blue-50 rounded-xl p-2 sm:p-4 text-center">
                                    <div class="text-lg sm:text-2xl font-bold text-blue-600">32</div>
                                    <div class="text-[10px] sm:text-xs text-blue-700">總門市</div>
                                </div>
                            </div>
                            <!-- Store Sync List -->
                            <div class="border rounded-lg overflow-hidden">
                                <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                                    <span class="font-bold text-sm text-gray-700">門市同步狀態</span>
                                    <button onclick="syncAllGDrive()" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition">
                                        <i class="fa-solid fa-rotate mr-1"></i>全部同步
                                    </button>
                                </div>
                                <div id="gdrive-sync-list" class="max-h-64 overflow-y-auto divide-y divide-gray-100">
                                    <!-- JS Generated -->
                                </div>
                            </div>
                        </div>
                        <!-- Side Panel -->
                        <div>
                            <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">API 連線</h4>
                            <div class="bg-white border rounded-lg p-4 mb-4 space-y-2">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Google Drive</span>
                                    <span class="text-green-600"><i class="fa-solid fa-circle-check mr-1"></i>已連接</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">n8n Webhook</span>
                                    <span class="text-green-600"><i class="fa-solid fa-circle-check mr-1"></i>已連接</span>
                                </div>
                            </div>
                            <h4 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">同步日誌</h4>
                            <div class="bg-white border rounded-lg p-4 text-xs space-y-1 max-h-48 overflow-y-auto" id="gdrive-logs">
                                <div class="text-gray-400">14:32:15 <span class="text-green-600">板橋光澤醫美 同步完成</span></div>
                                <div class="text-gray-400">14:31:48 <span class="text-green-600">建立資料夾: 新竹光澤</span></div>
                                <div class="text-gray-400">14:30:22 <span class="text-red-600">三重光澤 同步失敗</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="fixed z-20 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen px-4 py-6 text-center">
            <div class="fixed inset-0 bg-gray-900 bg-opacity-80 transition-opacity backdrop-blur-sm" onclick="closeAIModal()"></div>
            <div class="relative bg-white rounded-xl text-left overflow-hidden shadow-2xl transform transition-all sm:max-w-xl sm:w-full border border-violet-200">
                <div class="bg-gradient-to-r from-violet-600 to-fuchsia-600 p-4">
                    <h3 class="text-xl leading-6 font-bold text-white flex items-center">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> AI 智慧指令助手
                    </h3>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-4">使用自然語言快速管理門市、權限與 Role Email。</p>
                    <div class="relative rounded-md shadow-sm">
                        <textarea id="ai-input" rows="3" class="focus:ring-violet-500 focus:border-violet-500 block w-full sm:text-sm border-gray-300 rounded-md p-3 border" placeholder="例如：把板橋醫美的店長換成張三，或把忠孝岩盤浴的 Role Email 改成 tp_spa.admin@company.com"></textarea>
                        <div id="ai-loading" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden rounded-md backdrop-blur-sm">
                            <div class="flex flex-col items-center">
                                <i class="fa-solid fa-circle-notch fa-spin text-violet-600 text-3xl mb-2"></i>
                                <span class="text-sm text-violet-600 font-bold">Gemini 正在處理...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <p class="text-xs text-gray-400 font-bold mb-2 uppercase tracking-wide">試試看指令：</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="fillAIInput('把板橋醫美的店長換成 Tina')" class="text-xs bg-violet-50 text-violet-700 px-2 py-1 rounded-full border border-violet-200 hover:bg-violet-100 transition">換店長</button>
                            <button onclick="fillAIInput('修改板橋醫美的 Email 為 bz_med.new@company.com')" class="text-xs bg-violet-50 text-violet-700 px-2 py-1 rounded-full border border-violet-200 hover:bg-violet-100 transition">修改 Role Email</button>
                            <button onclick="fillAIInput('讓 David 可以看忠孝岩盤浴的營收報表')" class="text-xs bg-violet-50 text-violet-700 px-2 py-1 rounded-full border border-violet-200 hover:bg-violet-100 transition">授權看報表</button>
                        </div>
                    </div>

                    <div id="ai-result" class="mt-4 hidden p-3 bg-green-50 rounded-md border border-green-200 text-sm text-green-800">
                        <i class="fa-solid fa-check-circle mr-1"></i> <span id="ai-result-text"></span>
                    </div>
                    <div id="ai-error" class="mt-4 hidden p-3 bg-red-50 rounded-md border border-red-200 text-sm text-red-800">
                        <i class="fa-solid fa-circle-exclamation mr-1"></i> <span id="ai-error-text"></span>
                    </div>

                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="submitAICommand()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-violet-600 text-base font-medium text-white hover:bg-violet-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition">
                        執行指令
                    </button>
                    <button type="button" onclick="closeAIModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-100 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯 Modal -->
    <div id="modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-center justify-center min-h-screen">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="relative bg-white text-left overflow-hidden shadow-xl transform transition-all w-full h-full border-t-4 border-primary">
                
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 h-full overflow-y-auto">
                    <div class="sm:flex sm:items-start">
                        <div id="modal-icon-bg" class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i id="modal-icon" class="fa-solid fa-pen text-blue-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-xl leading-6 font-bold text-gray-900" id="modal-title">標題</h3>
                            <div class="mt-4" id="modal-content">
                                
                                <!-- FORM 0: 編輯門市設定 (Edit Store) -->
                                <div id="form-edit-store" class="form-section hidden">
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">門市名稱</label>
                                        <input type="text" id="edit-store-name" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm focus:ring-primary focus:border-primary">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">門市代碼 (不可修改)</label>
                                        <input type="text" id="edit-store-code" disabled class="block w-full border-gray-300 rounded-md border p-2 bg-gray-100 text-gray-500 cursor-not-allowed">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">角色 Email (Role Email)</label>
                                        <div class="flex rounded-md shadow-sm">
                                            <span class="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 bg-gray-50 text-gray-500 sm:text-sm">
                                                <i class="fa-regular fa-envelope"></i>
                                            </span>
                                            <input type="email" id="edit-store-email" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-r-md focus:ring-primary focus:border-primary sm:text-sm border-gray-300 border" placeholder="manager@company.com">
                                        </div>
                                        <p class="mt-2 text-xs text-gray-500">
                                            <i class="fa-solid fa-circle-info mr-1 text-blue-500"></i>
                                            修改此 Email 將同步更新 Google Drive 權限與 n8n 分派規則。
                                        </p>
                                    </div>
                                </div>

                                <!-- FORM 1: 指派主要店長 (Single) -->
                                <div id="form-primary" class="form-section hidden">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">選擇主要負責人</label>
                                    <select id="primary-select" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm focus:ring-primary focus:border-primary">
                                        <option value="1001">王小明 (店長)</option>
                                        <option value="3005">林函儀 (店長)</option>
                                        <option value="9999">-- 暫時懸缺 --</option>
                                    </select>
                                    <div class="mt-4 bg-yellow-50 p-3 rounded-md border border-yellow-200">
                                         <p class="text-xs text-yellow-700 font-bold mb-1"><i class="fa-solid fa-triangle-exclamation mr-1"></i> 注意：</p>
                                         <p class="text-xs text-yellow-700">該人員將自動繼承目前的 Role Email。若要修改 Email 地址，請使用「門市設定」功能。</p>
                                    </div>
                                </div>

                                <!-- FORM 2: 新增細部權限人員 (Granular) -->
                                <div id="form-granular" class="form-section hidden">
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">選擇員工/角色</label>
                                        <select id="granular-select" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm focus:ring-primary focus:border-primary">
                                            <option value="甲君">甲君 (區督導)</option>
                                            <option value="乙君">乙君 (儲備幹部)</option>
                                            <option value="Tina">Tina (區經理)</option>
                                            <option value="David">David (顧問)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">可存取的報表</label>
                                        <div class="mb-3 p-2 bg-indigo-50 rounded-md border border-indigo-200">
                                            <label class="block text-xs font-bold text-indigo-700 mb-1"><i class="fa-solid fa-bolt mr-1"></i>快速套用組合</label>
                                            <select id="granular-template-select" onchange="applyReportTemplate('granular')" class="block w-full border-indigo-300 rounded-md border p-1.5 text-sm shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                <option value="">-- 選擇報表組合 --</option>
                                            </select>
                                        </div>
                                        <input type="text" id="granular-report-search" placeholder="搜尋名稱、分類..." class="block w-full border-gray-300 rounded-md border p-2 shadow-sm mb-2 text-sm" oninput="filterReports('granular')">
                                        <div class="flex gap-2 mb-2">
                                            <button type="button" onclick="selectAllReports('granular')" class="text-sm text-blue-600 hover:text-blue-800">全選</button>
                                            <button type="button" onclick="deselectAllReports('granular')" class="text-sm text-gray-500 hover:text-gray-700">取消全選</button>
                                        </div>
                                        <div id="granular-report-list" class="space-y-1 overflow-y-auto border rounded-md p-2">
                                            <!-- 動態生成 -->
                                        </div>
                                    </div>
                                </div>

                                <!-- FORM 3: 新展店 -->
                                <div id="form-new-store" class="form-section hidden">
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">門市代碼</label>
                                        <input type="text" id="store-code" placeholder="TP_MED" oninput="autoGenEmail()" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">門市名稱</label>
                                        <input type="text" id="store-name" placeholder="台北醫美" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">預設 Role Email</label>
                                        <input type="email" id="store-email" placeholder="auto-generated..." class="block w-full border-gray-300 rounded-md border p-2 shadow-sm bg-gray-50">
                                    </div>
                                </div>


                                <!-- FORM 7: 新增報表組合 -->
                                <div id="form-new-template" class="form-section hidden">
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">組合名稱</label>
                                        <input type="text" id="template-name" placeholder="例：營運管理組合" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">適用說明</label>
                                        <input type="text" id="template-description" placeholder="例：適用於店長、區經理" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">包含報表</label>
                                        <input type="text" id="template-report-search" placeholder="搜尋名稱、分類..." class="block w-full border-gray-300 rounded-md border p-2 shadow-sm mb-2 text-sm" oninput="filterReports('template')">
                                        <div class="flex gap-2 mb-2">
                                            <button type="button" onclick="selectAllReports('template')" class="text-sm text-blue-600 hover:text-blue-800">全選</button>
                                            <button type="button" onclick="deselectAllReports('template')" class="text-sm text-gray-500 hover:text-gray-700">取消全選</button>
                                        </div>
                                        <div id="template-report-list" class="space-y-1 overflow-y-auto border rounded-md p-2">
                                            <!-- 動態生成 -->
                                        </div>
                                    </div>
                                </div>

                                <!-- FORM 8: 編輯報表組合 -->
                                <div id="form-edit-template" class="form-section hidden">
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">組合 ID (不可修改)</label>
                                        <input type="text" id="edit-template-id" disabled class="block w-full border-gray-300 rounded-md border p-2 bg-gray-100 text-gray-500 cursor-not-allowed">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">組合名稱</label>
                                        <input type="text" id="edit-template-name" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm">
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-bold text-gray-700 mb-2">適用說明</label>
                                        <input type="text" id="edit-template-description" class="block w-full border-gray-300 rounded-md border p-2 shadow-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">包含報表</label>
                                        <input type="text" id="edit-template-report-search" placeholder="搜尋名稱、分類..." class="block w-full border-gray-300 rounded-md border p-2 shadow-sm mb-2 text-sm" oninput="filterReports('edit-template')">
                                        <div class="flex gap-2 mb-2">
                                            <button type="button" onclick="selectAllReports('edit-template')" class="text-sm text-blue-600 hover:text-blue-800">全選</button>
                                            <button type="button" onclick="deselectAllReports('edit-template')" class="text-sm text-gray-500 hover:text-gray-700">取消全選</button>
                                        </div>
                                        <div id="edit-template-report-list" class="space-y-1 overflow-y-auto border rounded-md p-2">
                                            <!-- 動態生成 -->
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="saveData()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-blue-800 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm transition">
                        儲存並同步
                    </button>
                    <button type="button" onclick="closeModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-100 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm transition">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <!-- Mobile Bottom Nav -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 sm:hidden z-40 m-bnav">
        <div class="flex justify-around items-center h-14">
            <button onclick="switchTab('store')" id="bnav-store" class="flex flex-col items-center justify-center flex-1 h-full m-bnav-active">
                <i class="fa-solid fa-store text-base"></i>
                <span class="text-[10px] mt-0.5">門市</span>
            </button>
            <button onclick="switchTab('template')" id="bnav-template" class="flex flex-col items-center justify-center flex-1 h-full text-gray-400">
                <i class="fa-solid fa-clipboard-list text-base"></i>
                <span class="text-[10px] mt-0.5">報表</span>
            </button>
            <button onclick="openAIModal()" class="flex flex-col items-center justify-center flex-1 h-full text-violet-500">
                <div class="w-10 h-10 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-full flex items-center justify-center text-white shadow-lg -mt-4">
                    <i class="fa-solid fa-wand-magic-sparkles text-sm"></i>
                </div>
                <span class="text-[10px] mt-0.5">AI</span>
            </button>
            <button onclick="switchTab('settings')" id="bnav-settings" class="flex flex-col items-center justify-center flex-1 h-full text-gray-400">
                <i class="fa-solid fa-screwdriver-wrench text-base"></i>
                <span class="text-[10px] mt-0.5">設定</span>
            </button>
        </div>
    </nav>

    <div id="toast" class="fixed bottom-16 sm:bottom-5 right-5 hidden flex items-center w-full max-w-sm p-4 text-gray-500 bg-white rounded-lg shadow-lg border border-gray-200 transform transition-all duration-300 translate-y-10 opacity-0 z-50">
        <div id="toast-icon-bg" class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg">
            <i id="toast-icon" class="fa-solid fa-rotate animate-spin"></i>
        </div>
        <div class="ml-3 text-sm font-normal" id="toast-msg">同步中...</div>
    </div>

    <script>
        // --- DATA MODEL ---

        // 體系定義
        const BUSINESS_SYSTEMS = {
            all: { name: '全部體系', icon: 'fa-globe', color: 'text-white', bgColor: 'bg-slate-600' },
            guangze: { name: '星辰集團', icon: 'fa-star', color: 'text-yellow-300', bgColor: 'bg-indigo-600' },
            tcm: { name: '中醫體系', icon: 'fa-leaf', color: 'text-green-300', bgColor: 'bg-green-600' }
        };

        // 當前體系視角 (all = 最高管理員, guangze = 星辰集團, tcm = 中醫體系)
        let currentBusinessSystem = 'all';

        // 報表清單 - 包含代碼、正式名稱、分類
        let reportList = [
            // === 營運類 ===
            { code: 'R001', name: '護理部消耗報表', category: '營運' },
            { code: 'R006', name: '進銷貨明細', category: '營運' },
            { code: 'R009', name: '手術追蹤報表', category: '營運' },
            { code: 'R016', name: '諮詢師消耗額統計', category: '營運' },
            { code: 'R020', name: '生美、醫美品項明細表', category: '營運' },
            { code: 'R021', name: '非護理部手術消耗報表', category: '營運' },
            { code: 'R023', name: '高耗材異常領用清單', category: '營運' },
            { code: 'R024', name: '近半年銷售或消耗低於50報表', category: '營運' },
            { code: 'R028', name: '中醫藥膳消耗統計', category: '營運' },
            // === 人資類 ===
            { code: 'R003a', name: '新進人員名單&離職報表', category: '人資' },
            { code: 'R003b', name: '新人關懷名單', category: '人資' },
            { code: 'R011', name: '離職人數統計表', category: '人資' },
            { code: 'R014', name: '每月時數表', category: '人資' },
            { code: 'R025', name: '醫師考勤明細', category: '人資' },
            // === 財務/獎金類 ===
            { code: 'R004', name: '員購報表', category: '財務' },
            { code: 'R012', name: '電銷獎金經營客表', category: '財務' },
            { code: 'R013', name: '電銷獎金總表', category: '財務' },
            { code: 'R017', name: '諮詢師積分', category: '財務' },
            { code: 'R018', name: '營養師獎金報表', category: '財務' },
            { code: 'R026', name: '中醫諮詢師積分', category: '財務' },
            // === 電銷/行銷類 ===
            { code: 'R005', name: '好友專案報表', category: '行銷' },
            { code: 'R007', name: '好友介紹人報表', category: '行銷' },
            { code: 'R008', name: '電銷報表', category: '行銷' },
            // === 會員/客戶類 ===
            { code: 'R010', name: '設定影片名單', category: '會員' },
            { code: 'R022', name: '會員資料異動報表', category: '會員' },
            // === 系統/其他 ===
            { code: 'R015', name: '報修系統報表', category: '系統' },
            { code: 'R019', name: '報修系統積分表', category: '系統' },
            { code: 'R027', name: '各體系分院代碼', category: '系統' }
        ];

        // 報表分類顏色對照
        const reportCategoryColors = {
            '營運': { bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200', icon: 'fa-chart-line' },
            '人資': { bg: 'bg-violet-50', text: 'text-violet-700', border: 'border-violet-200', icon: 'fa-users' },
            '財務': { bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200', icon: 'fa-coins' },
            '行銷': { bg: 'bg-pink-50', text: 'text-pink-700', border: 'border-pink-200', icon: 'fa-bullhorn' },
            '會員': { bg: 'bg-cyan-50', text: 'text-cyan-700', border: 'border-cyan-200', icon: 'fa-id-card' },
            '系統': { bg: 'bg-gray-50', text: 'text-gray-600', border: 'border-gray-200', icon: 'fa-gear' }
        };

        // 人員清單 - 包含正式名稱、暱稱、職位
        let staffList = [
            { id: 'S001', name: '員工A', nickname: 'Alice', role: '區經理', businessSystem: 'guangze' },
            { id: 'S002', name: '員工B', nickname: '', role: '區經理', businessSystem: 'guangze' },
            { id: 'S003', name: '員工C', nickname: 'Carol', role: '區經理', businessSystem: 'guangze' },
            { id: 'S004', name: '員工D', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S005', name: '員工E', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S006', name: '員工F', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S007', name: '員工G', nickname: 'Grace', role: '店長', businessSystem: 'guangze' },
            { id: 'S008', name: '員工H', nickname: 'Helen', role: '店長', businessSystem: 'guangze' },
            { id: 'S009', name: '員工I', nickname: 'Ivy', role: '店長', businessSystem: 'guangze' },
            { id: 'S010', name: '員工J', nickname: 'Jenny', role: '店長', businessSystem: 'guangze' },
            { id: 'S011', name: '員工K', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S012', name: '員工L', nickname: 'Linda', role: '店長', businessSystem: 'guangze' },
            { id: 'S013', name: '員工M', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S014', name: '員工N', nickname: 'Nancy', role: '店長', businessSystem: 'guangze' },
            { id: 'S015', name: '員工O', nickname: 'Oscar', role: '店長', businessSystem: 'guangze' },
            { id: 'S016', name: '員工P', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S017', name: '員工Q', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S018', name: '員工R', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S019', name: '員工S', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S020', name: '主管A', nickname: '', role: '高階主管', businessSystem: 'guangze' },
            { id: 'S021', name: '主管B', nickname: '', role: '高階主管', businessSystem: 'guangze' },
            { id: 'S022', name: '主管C', nickname: '', role: '高階主管', businessSystem: 'guangze' },
            { id: 'S023', name: '員工T', nickname: '', role: '店長', businessSystem: 'guangze' },
            { id: 'S024', name: '員工U', nickname: '', role: '主管', businessSystem: 'guangze' },
            { id: 'S025', name: '員工V', nickname: '', role: '店長', businessSystem: 'guangze' },
            // === 中醫體系人員 ===
            { id: 'T001', name: '張醫師', nickname: 'Dr. Zhang', role: '院長', businessSystem: 'tcm' },
            { id: 'T002', name: '李店長', nickname: '', role: '店長', businessSystem: 'tcm' },
            { id: 'T003', name: '王諮詢', nickname: 'Consultant Wang', role: '諮詢師', businessSystem: 'tcm' },
            { id: 'T004', name: '趙經理', nickname: '', role: '區經理', businessSystem: 'tcm' },
            { id: 'T005', name: '孫主管', nickname: '', role: '高階主管', businessSystem: 'tcm' }
        ];

        // --- 報表組合 (Report Templates) ---
        let reportTemplates = [
            {
                id: 'RT001',
                name: '營運管理組合',
                description: '適用於店長、區經理',
                reports: ['R001', 'R006', 'R014', 'R016', 'R020']
            },
            {
                id: 'RT002',
                name: '人資報表組合',
                description: '適用於人資相關人員',
                reports: ['R003a', 'R003b', 'R011', 'R014']
            },
            {
                id: 'RT003',
                name: '財務報表組合',
                description: '適用於財務相關人員',
                reports: ['R004', 'R006', 'R012', 'R013']
            },
            {
                id: 'RT004',
                name: '諮詢師組合',
                description: '適用於諮詢師',
                reports: ['R016', 'R017', 'R026']
            },
            {
                id: 'RT005',
                name: '電銷組合',
                description: '適用於電銷人員',
                reports: ['R008', 'R012', 'R013']
            },
            {
                id: 'RT006',
                name: '全報表組合',
                description: '適用於高階主管',
                reports: [] // 空陣列代表全選
            }
        ];

        let stores = [
            // === 醫美部門 ===
            { code: 'N1_MED', name: '北一區星辰醫美', roleEmail: 'store01.manager@example.com', primaryManager: { name: '員工A Alice', status: 'active' }, authorizedUsers: [] },
            { code: 'C0_MED', name: '中央區星辰診所', roleEmail: 'store02.manager@example.com', primaryManager: { name: '員工D', status: 'active' }, authorizedUsers: [{ name: '員工A Alice', role: '多店管理', scopes: [] }] },
            { code: 'W1_MED', name: '西區星辰診所', roleEmail: 'store03.manager@example.com', primaryManager: { name: '員工P', status: 'active' }, authorizedUsers: [{ name: '員工A Alice', role: '多店管理', scopes: [] }] },
            { code: 'N1_HC', name: '北一區星辰健康門診', roleEmail: 'store04.manager@example.com', primaryManager: { name: '員工B', status: 'active' }, authorizedUsers: [] },
            { code: 'N2_MED', name: '北二區星辰診所', roleEmail: 'store05.manager@example.com', primaryManager: { name: '員工E', status: 'active' }, authorizedUsers: [{ name: '員工B', role: '多店管理', scopes: [] }] },
            { code: 'N3_MED', name: '北三區星辰診所', roleEmail: 'store06.manager@example.com', primaryManager: { name: '員工B', status: 'active' }, authorizedUsers: [] },
            { code: 'NW_MED', name: '西北區晨曦診所', roleEmail: 'store07.manager@example.com', primaryManager: { name: '員工F', status: 'active' }, authorizedUsers: [{ name: '員工B', role: '多店管理', scopes: [] }] },
            { code: 'E1_HC', name: '東區健康門診', roleEmail: 'store08.manager@example.com', primaryManager: { name: '員工C Carol', status: 'active' }, authorizedUsers: [] },
            { code: 'S1_MED', name: '南一區星辰診所', roleEmail: 'store09.manager@example.com', primaryManager: { name: '員工C Carol', status: 'active' }, authorizedUsers: [] },
            { code: 'C1_MED', name: '中一區星辰診所', roleEmail: 'store10.manager@example.com', primaryManager: { name: '員工G Grace', status: 'active' }, authorizedUsers: [] },
            { code: 'C2_MED', name: '中二區星辰診所', roleEmail: 'store11.manager@example.com', primaryManager: { name: '員工H Helen', status: 'active' }, authorizedUsers: [] },
            { code: 'C3_MED', name: '中三區星辰診所', roleEmail: 'store12.manager@example.com', primaryManager: { name: '員工I Ivy', status: 'active' }, authorizedUsers: [] },
            { code: 'NE_MED', name: '東北區星辰診所', roleEmail: 'store13.manager@example.com', primaryManager: { name: '員工I Ivy', status: 'active' }, authorizedUsers: [] },
            { code: 'SE_MED', name: '東南區星辰診所', roleEmail: 'store14.manager@example.com', primaryManager: { name: '員工J Jenny', status: 'active' }, authorizedUsers: [] },
            { code: 'S2_MED', name: '南區醫美診所', roleEmail: 'store15.manager@example.com', primaryManager: { name: '員工K', status: 'active' }, authorizedUsers: [] },
            { code: 'SW_MED', name: '西南區晨曦醫美', roleEmail: 'store16.manager@example.com', primaryManager: { name: '員工L Linda', status: 'active' }, authorizedUsers: [] },
            { code: 'SW_HC', name: '西南區晨曦健康門診', roleEmail: 'store17.manager@example.com', primaryManager: { name: '員工Q', status: 'active' }, authorizedUsers: [] },
            { code: 'W2_MED', name: '西二區醫美診所', roleEmail: 'store18.manager@example.com', primaryManager: { name: '員工M', status: 'active' }, authorizedUsers: [] },
            { code: 'CT_MED', name: '中區星辰診所', roleEmail: 'store19.manager@example.com', primaryManager: { name: '員工N Nancy', status: 'active' }, authorizedUsers: [] },
            { code: 'N4_MED', name: '北四區晨曦診所', roleEmail: 'store20.manager@example.com', primaryManager: { name: '員工O Oscar', status: 'active' }, authorizedUsers: [] },
            // === 養生館部門 ===
            { code: 'N1_SPA', name: '北一區養生館', roleEmail: 'spa01.manager@example.com', primaryManager: { name: '員工A Alice', status: 'active' }, authorizedUsers: [{ name: '員工T', role: '店長', scopes: [] }] },
            { code: 'C0_SPA', name: '中央區養生館', roleEmail: 'spa02.manager@example.com', primaryManager: { name: '員工D', status: 'active' }, authorizedUsers: [{ name: '員工U', role: '主管', scopes: [] }] },
            { code: 'CT_SPA', name: '中區養生館', roleEmail: 'spa03.manager@example.com', primaryManager: { name: '員工R', status: 'active' }, authorizedUsers: [] },
            { code: 'SE_SPA', name: '東南區養生館', roleEmail: 'spa04.manager@example.com', primaryManager: { name: '員工J Jenny', status: 'active' }, authorizedUsers: [{ name: '員工V', role: '店長', scopes: [] }] },
            { code: 'SW_SPA', name: '西南區養生館', roleEmail: 'spa05.manager@example.com', primaryManager: { name: '員工S', status: 'active' }, authorizedUsers: [] },
            { code: 'W2_SPA', name: '西二區養生館', roleEmail: 'spa06.manager@example.com', primaryManager: { name: '員工O Oscar', status: 'active' }, authorizedUsers: [] },
            // === 其他 ===
            { code: 'W3_SPA', name: '西三區養生館', roleEmail: 'w3_spa.manager@example.com', primaryManager: null, authorizedUsers: [] },
            { code: 'CC_SPA', name: '市中心養生館', roleEmail: 'cc_spa.manager@example.com', primaryManager: null, authorizedUsers: [] },
            { code: 'W3_MED', name: '西三區晨曦診所', roleEmail: 'w3_med.manager@example.com', primaryManager: null, authorizedUsers: [] },
            { code: 'E1_SPA', name: '東區養生館', roleEmail: 'e1_spa.manager@example.com', primaryManager: null, authorizedUsers: [] },
            { code: 'C1_OFC', name: '中一區辦公室', roleEmail: 'c1_ofc.manager@example.com', primaryManager: null, authorizedUsers: [] },
            { code: 'HQ', name: '星辰集團總管理處', roleEmail: 'hq.manager@example.com', primaryManager: null, authorizedUsers: [] },
            // === 中醫體系 (TCM) ===
            { code: 'NJ_TCM', name: '南京京都堂', roleEmail: 'tcm.nj.manager@company.com', primaryManager: { name: '南京店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'ZL_TCM', name: '中壢京都堂', roleEmail: 'tcm.zl.manager@company.com', primaryManager: { name: '中壢店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'TC_TCM', name: '台中京都堂', roleEmail: 'tcm.tc.manager@company.com', primaryManager: { name: '台中店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'LK_TCM', name: '林口京都堂', roleEmail: 'tcm.lk.manager@company.com', primaryManager: { name: '林口店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'GT_TCM', name: '古亭京都堂', roleEmail: 'tcm.gt.manager@company.com', primaryManager: { name: '古亭店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'SC_LST', name: '三重麗水堂', roleEmail: 'tcm.sc.manager@company.com', primaryManager: { name: '三重店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'XD_TCM', name: '新店京都堂', roleEmail: 'tcm.xd.manager@company.com', primaryManager: { name: '新店店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'BZ_TCM', name: '板橋京都堂', roleEmail: 'tcm.bz.manager@company.com', primaryManager: { name: '板橋店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'XZ_TCM', name: '新莊京都堂', roleEmail: 'tcm.xz.manager@company.com', primaryManager: { name: '新莊店長', status: 'active' }, authorizedUsers: [], businessSystem: 'tcm' },
            { code: 'TCM_HQ', name: '中醫總部', roleEmail: 'tcm.hq.manager@company.com', primaryManager: null, authorizedUsers: [], businessSystem: 'tcm' }
        ];

        let groups = [];

        let currentModalType = '';
        let currentIndex = -1;
        
        const apiKey = ""; // API Key

        // --- RENDER ---
        function renderStores() {
            const tbody = document.getElementById('store-list');
            const mobileList = document.getElementById('store-list-mobile');
            tbody.innerHTML = '';
            mobileList.innerHTML = '';
            updateStoreCounts();
            const filteredStores = getFilteredStores();

            if (filteredStores.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                            <i class="fa-solid fa-search text-4xl text-gray-300 mb-3"></i>
                            <p class="font-medium">找不到符合條件的門市</p>
                            <p class="text-sm">請嘗試其他搜尋條件或篩選器</p>
                        </td>
                    </tr>`;
                mobileList.innerHTML = `<div class="py-8 text-center text-gray-400 text-xs"><i class="fa-solid fa-search text-2xl mb-2 block"></i>找不到符合條件的門市</div>`;
                return;
            }

            filteredStores.forEach((store) => {
                const index = stores.indexOf(store);
                // Primary Manager UI
                let primaryHtml = '';
                if(store.primaryManager) {
                    primaryHtml = `
                        <div class="flex flex-col">
                            <div class="flex items-center mb-1">
                                <div class="h-8 w-8 rounded-full bg-primary text-white flex items-center justify-center font-bold text-xs mr-2 border-2 border-white shadow-sm ring-1 ring-gray-200">
                                    ${store.primaryManager.name.substring(0,1)}
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-900">${store.primaryManager.name}</div>
                                    <div class="text-xs text-green-600"><i class="fa-solid fa-circle-check"></i> 權限生效</div>
                                </div>
                            </div>
                            <div class="flex items-center ml-10">
                                <span class="bg-gray-100 text-gray-600 text-[11px] px-2 py-0.5 rounded border border-gray-300 flex items-center font-mono group cursor-pointer hover:bg-gray-200" onclick="openModal('edit-store', ${index})" title="點擊編輯 Email">
                                    <i class="fa-regular fa-envelope mr-1.5 text-gray-400"></i> ${store.roleEmail}
                                </span>
                            </div>
                        </div>`;
                } else {
                    primaryHtml = `
                        <div class="flex flex-col">
                             <div class="flex items-center">
                                <span class="text-sm text-red-500 font-bold bg-red-50 px-2 py-1 rounded border border-red-200"><i class="fa-solid fa-triangle-exclamation mr-1"></i>未指派</span>
                             </div>
                             <div class="flex items-center mt-2">
                                <span class="bg-gray-50 text-gray-400 text-[11px] px-2 py-0.5 rounded border border-gray-200 flex items-center font-mono group cursor-pointer hover:bg-gray-100" onclick="openModal('edit-store', ${index})" title="點擊編輯 Email">
                                    <i class="fa-regular fa-envelope mr-1.5"></i> ${store.roleEmail}
                                </span>
                            </div>
                        </div>`;
                }

                // Granular Users UI
                let granularHtml = '';
                if(store.authorizedUsers.length === 0) granularHtml = '<span class="text-xs text-gray-400">無其他授權人員</span>';
                else {
                    granularHtml = '<div class="space-y-1">';
                    store.authorizedUsers.forEach(u => {
                        granularHtml += `
                            <div class="flex items-center text-sm bg-gray-50 px-2 py-1 rounded border border-gray-100">
                                <span class="font-medium mr-2">${u.name}</span>
                                <span class="text-xs text-gray-500 mr-2">(${u.role})</span>
                                <div class="flex flex-wrap gap-1">${formatReportBadges(u.scopes, 3)}</div>
                            </div>`;
                    });
                    granularHtml += '</div>';
                }

                const cat = getStoreCategory(store);
                let catIcon = '<i class="fa-solid fa-building text-gray-400 mr-1.5"></i>';
                if (cat === 'spa') catIcon = '<i class="fa-solid fa-spa text-amber-500 mr-1.5"></i>';
                else if (cat === 'med') catIcon = '<i class="fa-solid fa-syringe text-pink-500 mr-1.5"></i>';
                else if (cat === 'tcm') catIcon = '<i class="fa-solid fa-leaf text-green-600 mr-1.5"></i>';

                // Desktop row
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition store-row">
                        <td class="px-6 py-4 align-top">
                            <div class="flex justify-between items-start">
                                <div>
                                    <div class="text-sm font-bold text-gray-900">${catIcon}${store.name}</div>
                                    <div class="text-xs text-gray-500 font-mono bg-gray-100 px-1 rounded inline-block mt-1">${store.code}</div>
                                </div>
                                <button onclick="openModal('edit-store', ${index})" class="text-gray-400 hover:text-primary transition p-1" title="門市設定 & Email 維護">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-4 align-top border-l border-r border-gray-100 bg-blue-50/20">
                            <div class="flex flex-col h-full justify-between">
                                ${primaryHtml}
                                <button onclick="openModal('primary', ${index})" class="text-sm text-blue-600 hover:text-blue-800 mt-2 text-left font-bold pl-10 flex items-center">
                                    <i class="fa-solid fa-arrow-right-arrow-left mr-1"></i> 權限移轉
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-4 align-top">
                            ${granularHtml}
                        </td>
                        <td class="px-6 py-4 align-top text-right">
                             <button onclick="openModal('granular', ${index})" class="text-gray-500 hover:text-primary font-bold border border-gray-300 hover:bg-gray-50 px-2 py-1 rounded text-xs transition">
                                <i class="fa-solid fa-plus"></i> 加人
                            </button>
                        </td>
                    </tr>
                `;

                // Mobile compact row
                const mgrName = store.primaryManager ? store.primaryManager.name : '未指派';
                const mgrClass = store.primaryManager ? 'text-gray-700' : 'text-red-500';
                const authCount = store.authorizedUsers.length;
                mobileList.innerHTML += `
                    <div class="px-3 py-2 active:bg-gray-50" onclick="openModal('edit-store', ${index})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1.5 min-w-0 flex-1">
                                ${catIcon}
                                <span class="text-xs font-bold text-gray-900 truncate">${store.name}</span>
                                <span class="text-[10px] text-gray-400 font-mono flex-shrink-0">${store.code}</span>
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                <button onclick="event.stopPropagation();openModal('granular', ${index})" class="text-gray-400 hover:text-primary p-1 text-xs"><i class="fa-solid fa-user-plus"></i></button>
                                <button onclick="event.stopPropagation();openModal('edit-store', ${index})" class="text-gray-400 hover:text-primary p-1 text-xs"><i class="fa-solid fa-gear"></i></button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mt-0.5 text-[10px]">
                            <span class="${mgrClass}"><i class="fa-solid fa-user-tie mr-0.5"></i>${mgrName}</span>
                            <span class="text-gray-300">|</span>
                            <span class="text-gray-400 truncate"><i class="fa-regular fa-envelope mr-0.5"></i>${store.roleEmail}</span>
                            ${authCount > 0 ? `<span class="bg-blue-100 text-blue-600 px-1 rounded text-[9px] flex-shrink-0">+${authCount}</span>` : ''}
                        </div>
                    </div>
                `;
            });
        }

        function toggleSystemDropdown() {
            const dropdown = document.getElementById('system-dropdown');
            dropdown.classList.toggle('hidden');
        }

        // 點擊外部關閉下拉選單
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('system-dropdown');
            const btn = document.getElementById('system-dropdown-btn');
            if (dropdown && btn && !btn.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });

        function setBusinessSystem(system) {
            currentBusinessSystem = system;
            const systemInfo = BUSINESS_SYSTEMS[system];

            // 更新按鈕顯示
            document.getElementById('system-name').textContent = systemInfo.name;
            const iconEl = document.getElementById('system-icon');
            iconEl.className = `fa-solid ${systemInfo.icon} mr-2`;

            // 更新下拉選單選中狀態
            document.querySelectorAll('.system-option').forEach(opt => {
                const checkIcon = opt.querySelector('.fa-check');
                if (opt.dataset.system === system) {
                    checkIcon.classList.remove('hidden');
                } else {
                    checkIcon.classList.add('hidden');
                }
            });

            // 關閉下拉選單
            document.getElementById('system-dropdown').classList.add('hidden');

            // 更新篩選按鈕標籤
            updateFilterButtonLabels();

            // 重置部門篩選為全部
            currentStoreFilter = 'all';
            document.querySelectorAll('.store-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('filter-all').classList.add('active');
            const mFilterAll = document.getElementById('filter-all-m');
            if (mFilterAll) mFilterAll.classList.add('active');

            // 重新渲染
            renderStores();
            updateHeaderStats();
        }

        function updateFilterButtonLabels() {
            const medBtn = document.getElementById('filter-med');
            const spaBtn = document.getElementById('filter-spa');
            const medBtnM = document.getElementById('filter-med-m');
            const spaBtnM = document.getElementById('filter-spa-m');

            if (currentBusinessSystem === 'tcm') {
                medBtn.innerHTML = '<i class="fa-solid fa-leaf mr-1 text-green-600"></i>中醫 <span class="ml-1 text-xs bg-green-100 text-green-600 px-1.5 rounded" id="count-med">0</span>';
                spaBtn.style.display = 'none';
                if (medBtnM) medBtnM.innerHTML = '<i class="fa-solid fa-leaf mr-0.5 text-green-600"></i>中醫<span class="ml-0.5 bg-green-100 text-green-600 px-1 rounded" id="count-med-m">0</span>';
                if (spaBtnM) spaBtnM.style.display = 'none';
            } else {
                medBtn.innerHTML = '<i class="fa-solid fa-syringe mr-1 text-pink-500"></i>醫美 <span class="ml-1 text-xs bg-pink-100 text-pink-600 px-1.5 rounded" id="count-med">0</span>';
                spaBtn.style.display = '';
                spaBtn.innerHTML = '<i class="fa-solid fa-spa mr-1 text-amber-500"></i>岩盤浴 <span class="ml-1 text-xs bg-amber-100 text-amber-600 px-1.5 rounded" id="count-spa">0</span>';
                if (medBtnM) { medBtnM.innerHTML = '<i class="fa-solid fa-syringe mr-0.5 text-pink-500"></i>醫美<span class="ml-0.5 bg-pink-100 text-pink-600 px-1 rounded" id="count-med-m">0</span>'; }
                if (spaBtnM) { spaBtnM.style.display = ''; spaBtnM.innerHTML = '<i class="fa-solid fa-spa mr-0.5 text-amber-500"></i>養生<span class="ml-0.5 bg-amber-100 text-amber-600 px-1 rounded" id="count-spa-m">0</span>'; }
            }
        }

        function updateHeaderStats() {
            const visibleStores = stores.filter(store => {
                if (currentBusinessSystem === 'all') return true;
                return getStoreBusinessSystem(store) === currentBusinessSystem;
            });

            let countMed = 0, countSpa = 0, countTcm = 0;
            visibleStores.forEach(store => {
                const cat = getStoreCategory(store);
                if (cat === 'med') countMed++;
                else if (cat === 'spa') countSpa++;
                else if (cat === 'tcm') countTcm++;
            });

            const statsContainer = document.querySelector('.hidden.md\\:flex.items-center.space-x-3.mr-4');
            if (statsContainer) {
                if (currentBusinessSystem === 'tcm') {
                    statsContainer.innerHTML = `
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-leaf mr-1.5 text-green-300"></i>中醫 <span class="font-bold ml-1">${countTcm}</span>
                        </span>
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-file-lines mr-1.5 text-cyan-300"></i>報表 <span class="font-bold ml-1">${reportList.length}</span>
                        </span>
                    `;
                } else {
                    statsContainer.innerHTML = `
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-syringe mr-1.5 text-pink-300"></i>醫美 <span class="font-bold ml-1">${countMed}</span>
                        </span>
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-spa mr-1.5 text-amber-300"></i>岩盤浴 <span class="font-bold ml-1">${countSpa}</span>
                        </span>
                        <span class="flex items-center text-xs text-blue-200 bg-blue-800/50 px-2 py-1 rounded">
                            <i class="fa-solid fa-file-lines mr-1.5 text-cyan-300"></i>報表 <span class="font-bold ml-1">${reportList.length}</span>
                        </span>
                    `;
                }
            }
        }

        // 取得門市所屬體系
        function getStoreBusinessSystem(store) {
            if (store.businessSystem) return store.businessSystem;
            const code = store.code.toUpperCase();
            const name = store.name;
            if (code.includes('TCM') || code.includes('LST') || code.includes('JJT') || code.includes('HST') ||
                name.includes('京都堂') || name.includes('麗水堂') || name.includes('京基堂') || name.includes('和申堂')) {
                return 'tcm';
            }
            return 'guangze';
        }


        function renderReportTemplates() {
            const tbody = document.getElementById('template-list');
            const mobileList = document.getElementById('template-list-mobile');
            tbody.innerHTML = '';
            mobileList.innerHTML = '';
            const filteredTemplates = getFilteredTemplates();

            if (filteredTemplates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-gray-500">
                            <i class="fa-solid fa-clipboard-list text-4xl text-gray-300 mb-3"></i>
                            <p class="font-medium">找不到符合條件的報表組合</p>
                            <p class="text-sm">請嘗試其他搜尋條件</p>
                        </td>
                    </tr>`;
                mobileList.innerHTML = `<div class="py-8 text-center text-gray-400 text-xs"><i class="fa-solid fa-clipboard-list text-2xl mb-2 block"></i>找不到符合條件的報表組合</div>`;
                return;
            }

            filteredTemplates.forEach((template) => {
                const index = reportTemplates.indexOf(template);
                const isAllReports = template.reports.length === 0;
                const reportCount = isAllReports ? reportList.length : template.reports.length;

                let reportBadgesHtml = '';
                let categorySummary = '';

                if (isAllReports) {
                    reportBadgesHtml = '<span class="bg-gradient-to-r from-indigo-100 to-purple-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-bold border border-indigo-200"><i class="fa-solid fa-infinity mr-1"></i>全部報表</span>';
                    categorySummary = '包含所有分類';
                } else {
                    reportBadgesHtml = formatReportBadges(template.reports, 4);
                    const catCounts = {};
                    template.reports.forEach(code => {
                        const cat = getReportCategory(code);
                        catCounts[cat] = (catCounts[cat] || 0) + 1;
                    });
                    categorySummary = Object.entries(catCounts).map(([cat, count]) => `${cat}${count}`).join('、');
                }

                // Desktop row
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-6 py-4">
                            <div class="font-bold text-base text-gray-900">${template.name}</div>
                            <div class="text-xs text-gray-400 mt-1">${template.id}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${template.description}</div>
                            <div class="text-[10px] text-gray-400 mt-1">${categorySummary}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap gap-1">${reportBadgesHtml}</div>
                            <div class="text-xs text-gray-400 mt-1">共 ${reportCount} 份報表</div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="openModal('edit-template', ${index})" class="text-gray-500 hover:text-indigo-600 font-bold border border-gray-300 hover:bg-indigo-50 hover:border-indigo-300 px-2 py-1 rounded text-xs transition" title="編輯組合">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                                <button onclick="deleteReportTemplate(${index})" class="text-gray-500 hover:text-red-600 font-bold border border-gray-300 hover:bg-red-50 hover:border-red-300 px-2 py-1 rounded text-xs transition" title="刪除組合">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;

                // Mobile compact row
                const mBadge = isAllReports
                    ? '<span class="bg-indigo-100 text-indigo-600 px-1 rounded text-[9px]"><i class="fa-solid fa-infinity mr-0.5"></i>全部</span>'
                    : `<span class="bg-gray-100 text-gray-600 px-1 rounded text-[9px]">${reportCount}份</span>`;
                mobileList.innerHTML += `
                    <div class="px-3 py-2 active:bg-gray-50" onclick="openModal('edit-template', ${index})">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1.5 min-w-0 flex-1">
                                <span class="text-xs font-bold text-gray-900 truncate">${template.name}</span>
                                ${mBadge}
                            </div>
                            <div class="flex items-center gap-1 flex-shrink-0 ml-2">
                                <button onclick="event.stopPropagation();openModal('edit-template', ${index})" class="text-gray-400 hover:text-indigo-600 p-1 text-xs"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="event.stopPropagation();deleteReportTemplate(${index})" class="text-gray-400 hover:text-red-600 p-1 text-xs"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-0.5 truncate">${template.description} · ${categorySummary}</div>
                    </div>
                `;
            });
        }

        // --- FILTER & SEARCH ---
        let currentStoreFilter = 'all';
        let currentStoreSearch = '';

        function getStoreCategory(store) {
            const code = store.code.toUpperCase();
            const businessSystem = getStoreBusinessSystem(store);

            if (businessSystem === 'tcm') {
                if (code.includes('HQ') || store.name.includes('總部')) return 'other';
                return 'tcm';
            }

            if (code.includes('SPA')) return 'spa';
            if (code.includes('MED') || code.includes('GZ') || code.includes('TY') || code.includes('JB')) return 'med';
            return 'other';
        }

        function updateStoreCounts() {
            const visibleStores = stores.filter(store => {
                if (currentBusinessSystem === 'all') return true;
                return getStoreBusinessSystem(store) === currentBusinessSystem;
            });

            let countAll = 0, countMed = 0, countSpa = 0, countOther = 0, countTcm = 0;
            visibleStores.forEach(store => {
                const cat = getStoreCategory(store);
                countAll++;
                if (cat === 'med') countMed++;
                else if (cat === 'spa') countSpa++;
                else if (cat === 'tcm') countTcm++;
                else countOther++;
            });
            document.getElementById('count-all').textContent = countAll;
            if (currentBusinessSystem === 'tcm') {
                document.getElementById('count-med').textContent = countTcm;
                document.getElementById('count-spa').textContent = '0';
            } else {
                document.getElementById('count-med').textContent = countMed;
                document.getElementById('count-spa').textContent = countSpa;
            }
            document.getElementById('count-other').textContent = countOther;
            
            // Mobile counters
            document.getElementById('count-all-m').textContent = countAll;
            if (currentBusinessSystem === 'tcm') {
                document.getElementById('count-med-m').textContent = countTcm;
                document.getElementById('count-spa-m').textContent = '0';
            } else {
                document.getElementById('count-med-m').textContent = countMed;
                document.getElementById('count-spa-m').textContent = countSpa;
            }
            document.getElementById('count-other-m').textContent = countOther;
        }

        function setStoreFilter(filter) {
            currentStoreFilter = filter;
            document.querySelectorAll('.store-filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            const mBtn = document.getElementById(`filter-${filter}-m`);
            if (mBtn) mBtn.classList.add('active');
            renderStores();
        }

        function filterStores() {
            const desktopInput = document.getElementById('store-search');
            const mobileInput = document.getElementById('store-search-m');
            currentStoreSearch = (desktopInput.value || mobileInput.value).toLowerCase();
            renderStores();
        }

        function getFilteredStores() {
            return stores.filter(store => {
                // 體系視角篩選
                if (currentBusinessSystem !== 'all') {
                    const storeSystem = getStoreBusinessSystem(store);
                    if (storeSystem !== currentBusinessSystem) return false;
                }
                // 部門篩選
                if (currentStoreFilter !== 'all') {
                    const cat = getStoreCategory(store);
                    if (cat !== currentStoreFilter) return false;
                }
                // 搜尋篩選
                if (currentStoreSearch) {
                    const searchFields = [
                        store.name,
                        store.code,
                        store.roleEmail,
                        store.primaryManager?.name || ''
                    ].join(' ').toLowerCase();
                    if (!searchFields.includes(currentStoreSearch)) return false;
                }
                return true;
            });
        }


        let currentTemplateSearch = '';

        function filterTemplates() {
            const desktopInput = document.getElementById('template-search');
            const mobileInput = document.getElementById('template-search-m');
            currentTemplateSearch = (desktopInput.value || mobileInput.value).toLowerCase();
            renderReportTemplates();
        }

        function getFilteredTemplates() {
            if (!currentTemplateSearch) return reportTemplates;
            return reportTemplates.filter(template => {
                const searchFields = [
                    template.name,
                    template.description,
                    template.id,
                    template.reports.join(' ')
                ].join(' ').toLowerCase();
                return searchFields.includes(currentTemplateSearch);
            });
        }

        // --- STAFF FUNCTIONS ---


        // --- REPORT FUNCTIONS ---
        function generateReportCheckboxes(containerId, namePrefix, checkedCodes = []) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const categories = ['營運', '人資', '財務', '行銷', '會員', '系統'];

            // 建立分類籤頁 HTML
            let tabsHtml = '<div class="report-tabs flex flex-wrap gap-1 mb-2 border-b border-gray-200 pb-2">';
            categories.forEach((category, idx) => {
                const colors = reportCategoryColors[category];
                const count = reportList.filter(r => r.category === category).length;
                const isActive = idx === 0;
                tabsHtml += `
                    <button type="button" class="report-tab ${isActive ? 'active' : ''} px-2 py-1 text-xs font-bold rounded-t transition-all border-b-2
                            ${isActive ? colors.bg + ' ' + colors.text + ' border-current' : 'text-gray-400 border-transparent hover:text-gray-600 hover:bg-gray-50'}"
                            data-category="${category}" data-container="${containerId}"
                            onclick="switchReportTab(this, '${containerId}')">
                        <i class="fa-solid ${colors.icon} mr-1"></i>${category}
                        <span class="ml-0.5 text-[10px] opacity-70">${count}</span>
                    </button>
                `;
            });
            tabsHtml += '</div>';

            // 建立搜尋結果區域（預設隱藏）
            let searchResultsHtml = `
                <div class="report-search-results hidden" data-container="${containerId}">
                    <div class="flex items-center justify-between mb-2 px-1">
                        <span class="text-xs font-bold text-violet-600"><i class="fa-solid fa-search mr-1"></i>搜尋結果</span>
                        <span class="report-search-count text-[10px] text-gray-400"></span>
                    </div>
                    <div class="report-search-grid grid grid-cols-2 gap-1.5"></div>
                </div>
            `;

            // 建立各分類的內容區域（雙欄網格）
            let contentHtml = '<div class="report-tab-contents">';
            categories.forEach((category, idx) => {
                const reportsInCategory = reportList.filter(r => r.category === category);
                if (reportsInCategory.length === 0) return;

                const colors = reportCategoryColors[category];
                const isHidden = idx !== 0;

                contentHtml += `<div class="report-tab-content ${isHidden ? 'hidden' : ''}" data-category="${category}">
                        <div class="grid grid-cols-2 gap-1.5">`;

                reportsInCategory.forEach(r => {
                    const isChecked = checkedCodes.includes(r.code);
                    contentHtml += `
                        <label class="flex items-center p-2 rounded-lg cursor-pointer report-item transition-all border
                               ${isChecked ? colors.border + ' ' + colors.bg : 'border-gray-100 hover:border-gray-200 hover:' + colors.bg}"
                               data-code="${r.code}" data-name="${r.name}" data-category="${r.category}">
                            <input type="checkbox" name="${namePrefix}" value="${r.code}" ${isChecked ? 'checked' : ''}
                                   class="text-primary rounded mr-2 w-3.5 h-3.5 flex-shrink-0"
                                   onchange="updateReportItemStyle(this)">
                            <div class="flex-1 min-w-0">
                                <div class="text-xs font-medium text-gray-800 truncate leading-tight">${r.name}</div>
                                <span class="text-[10px] text-gray-400">${r.code}</span>
                            </div>
                        </label>
                    `;
                });

                contentHtml += '</div></div>';
            });
            contentHtml += '</div>';

            container.innerHTML = tabsHtml + searchResultsHtml + contentHtml;
        }

        // 更新報表項目的選中樣式
        function updateReportItemStyle(checkbox) {
            const label = checkbox.closest('.report-item');
            if (!label) return;
            const category = label.dataset.category;
            const colors = reportCategoryColors[category] || reportCategoryColors['系統'];

            // 移除所有可能的樣式類
            label.classList.remove('border-gray-100', 'hover:border-gray-200');
            Object.values(reportCategoryColors).forEach(c => {
                label.classList.remove(c.border, c.bg);
            });

            if (checkbox.checked) {
                label.classList.add(colors.border, colors.bg);
            } else {
                label.classList.add('border-gray-100', 'hover:border-gray-200');
            }
        }

        // 切換報表分類籤頁
        function switchReportTab(button, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            const category = button.dataset.category;

            // 更新所有籤頁按鈕樣式
            container.querySelectorAll('.report-tab').forEach(tab => {
                const tabCat = tab.dataset.category;
                const tabColors = reportCategoryColors[tabCat];
                // 先移除所有樣式
                tab.classList.remove('active', 'border-current');
                Object.values(reportCategoryColors).forEach(c => {
                    tab.classList.remove(c.bg, c.text);
                });

                if (tab === button) {
                    tab.classList.add('active', tabColors.bg, tabColors.text, 'border-current');
                    tab.classList.remove('text-gray-400', 'border-transparent', 'hover:text-gray-600', 'hover:bg-gray-50');
                } else {
                    tab.classList.add('text-gray-400', 'border-transparent', 'hover:text-gray-600', 'hover:bg-gray-50');
                }
            });

            // 切換內容區域
            container.querySelectorAll('.report-tab-content').forEach(content => {
                content.classList.toggle('hidden', content.dataset.category !== category);
            });
        }

        function filterReports(type) {
            const searchInput = document.getElementById(`${type}-report-search`);
            const container = document.getElementById(`${type}-report-list`);
            if (!searchInput || !container) return;

            const keyword = searchInput.value.toLowerCase().trim();
            const tabsEl = container.querySelector('.report-tabs');
            const tabContentsEl = container.querySelector('.report-tab-contents');
            const searchResultsEl = container.querySelector('.report-search-results');

            if (!keyword) {
                // 清空搜尋：顯示籤頁模式
                if (tabsEl) tabsEl.classList.remove('hidden');
                if (tabContentsEl) tabContentsEl.classList.remove('hidden');
                if (searchResultsEl) searchResultsEl.classList.add('hidden');
                return;
            }

            // 有搜尋關鍵字：切換到搜尋結果模式
            if (tabsEl) tabsEl.classList.add('hidden');
            if (tabContentsEl) tabContentsEl.classList.add('hidden');
            if (searchResultsEl) {
                searchResultsEl.classList.remove('hidden');

                // 找出符合的報表
                const matchedReports = reportList.filter(r => {
                    return r.code.toLowerCase().includes(keyword) ||
                           r.name.toLowerCase().includes(keyword) ||
                           r.category.toLowerCase().includes(keyword);
                });

                // 取得目前已選中的報表
                const checkedCodes = [];
                container.querySelectorAll('.report-tab-contents input[type="checkbox"]:checked').forEach(cb => {
                    checkedCodes.push(cb.value);
                });

                // 取得 namePrefix
                const firstCheckbox = container.querySelector('.report-tab-contents input[type="checkbox"]');
                const namePrefix = firstCheckbox ? firstCheckbox.name : 'search-scopes';

                // 生成搜尋結果 HTML
                const searchGrid = searchResultsEl.querySelector('.report-search-grid');
                const searchCount = searchResultsEl.querySelector('.report-search-count');

                if (matchedReports.length === 0) {
                    searchGrid.innerHTML = '<div class="col-span-2 text-center text-gray-400 text-sm py-4"><i class="fa-solid fa-search mr-1"></i>找不到符合的報表</div>';
                    searchCount.textContent = '';
                } else {
                    searchCount.textContent = `共 ${matchedReports.length} 項`;
                    searchGrid.innerHTML = matchedReports.map(r => {
                        const colors = reportCategoryColors[r.category] || reportCategoryColors['系統'];
                        const isChecked = checkedCodes.includes(r.code);
                        return `
                            <label class="flex items-center p-2 rounded-lg cursor-pointer report-search-item transition-all border
                                   ${isChecked ? colors.border + ' ' + colors.bg : 'border-gray-100 hover:border-gray-200 hover:' + colors.bg}"
                                   data-code="${r.code}" data-category="${r.category}">
                                <input type="checkbox" value="${r.code}" ${isChecked ? 'checked' : ''}
                                       class="text-primary rounded mr-2 w-3.5 h-3.5 flex-shrink-0"
                                       onchange="syncSearchCheckbox(this, '${containerId}', '${namePrefix}')">
                                <div class="flex-1 min-w-0">
                                    <div class="text-xs font-medium text-gray-800 truncate leading-tight">${r.name}</div>
                                    <div class="flex items-center gap-1">
                                        <span class="text-[10px] text-gray-400">${r.code}</span>
                                        <span class="text-[9px] ${colors.text} ${colors.bg} px-1 rounded">${r.category}</span>
                                    </div>
                                </div>
                            </label>
                        `;
                    }).join('');
                }
            }
        }

        // 同步搜尋結果的勾選狀態到實際的 checkbox
        function syncSearchCheckbox(searchCheckbox, containerId, namePrefix) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const code = searchCheckbox.value;
            const isChecked = searchCheckbox.checked;

            // 更新籤頁內容區的對應 checkbox
            const realCheckbox = container.querySelector(`.report-tab-contents input[value="${code}"]`);
            if (realCheckbox) {
                realCheckbox.checked = isChecked;
                updateReportItemStyle(realCheckbox);
            }

            // 更新搜尋結果項目的樣式
            const label = searchCheckbox.closest('.report-search-item');
            if (label) {
                const category = label.dataset.category;
                const colors = reportCategoryColors[category] || reportCategoryColors['系統'];

                label.classList.remove('border-gray-100', 'hover:border-gray-200');
                Object.values(reportCategoryColors).forEach(c => {
                    label.classList.remove(c.border, c.bg);
                });

                if (isChecked) {
                    label.classList.add(colors.border, colors.bg);
                } else {
                    label.classList.add('border-gray-100', 'hover:border-gray-200');
                }
            }
        }

        function selectAllReports(type) {
            const container = document.getElementById(`${type}-report-list`);
            if (!container) return;

            // 檢查是否在搜尋模式
            const searchResultsEl = container.querySelector('.report-search-results');
            const isSearchMode = searchResultsEl && !searchResultsEl.classList.contains('hidden');

            if (isSearchMode) {
                // 搜尋模式：勾選搜尋結果中的所有項目
                searchResultsEl.querySelectorAll('.report-search-item input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                    syncSearchCheckbox(cb, `${type}-report-list`, cb.name);
                });
            } else {
                // 籤頁模式：勾選當前籤頁中的所有項目
                const activeTab = container.querySelector('.report-tab-content:not(.hidden)');
                if (activeTab) {
                    activeTab.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = true;
                        updateReportItemStyle(cb);
                    });
                }
            }
        }

        function deselectAllReports(type) {
            const container = document.getElementById(`${type}-report-list`);
            if (!container) return;

            // 取消所有 checkbox（包括籤頁內容和搜尋結果）
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
                updateReportItemStyle(cb);
            });
        }

        function getSelectedReports(namePrefix) {
            const selected = [];
            document.querySelectorAll(`input[name="${namePrefix}"]:checked`).forEach(cb => selected.push(cb.value));
            return selected;
        }

        // 取得報表物件（根據代碼）
        function getReport(code) {
            return reportList.find(r => r.code === code);
        }

        // 取得報表名稱
        function getReportName(code) {
            const report = getReport(code);
            return report ? report.name : code;
        }

        // 取得報表分類
        function getReportCategory(code) {
            const report = getReport(code);
            return report ? report.category : '其他';
        }

        // 取得人員顯示名稱（有暱稱則顯示：名字 暱稱）
        function getStaffDisplayName(name) {
            const staff = staffList.find(s => s.name === name || s.nickname === name);
            if (!staff) return name;
            return staff.nickname ? `${staff.name} ${staff.nickname}` : staff.name;
        }

        // 取得人員物件
        function getStaff(nameOrNickname) {
            return staffList.find(s => s.name === nameOrNickname || s.nickname === nameOrNickname);
        }

        function formatReportBadges(scopes, maxShow = 3) {
            if (!scopes || scopes.length === 0) return '<span class="text-xs text-gray-400">無指定報表</span>';
            const shown = scopes.slice(0, maxShow);
            const remaining = scopes.length - maxShow;
            let html = shown.map(code => {
                const report = getReport(code);
                const name = report ? report.name : code;
                const category = report ? report.category : '其他';
                const colors = reportCategoryColors[category] || reportCategoryColors['系統'];
                // 截短過長名稱
                const shortName = name.length > 8 ? name.substring(0, 8) + '...' : name;
                return `<span class="px-2 py-0.5 rounded text-[11px] ${colors.bg} ${colors.text} border ${colors.border}" title="${name} (${code})">${shortName}</span>`;
            }).join(' ');
            if (remaining > 0) {
                const remainingNames = scopes.slice(maxShow).map(c => getReportName(c)).join('、');
                html += ` <span class="text-[11px] text-gray-500 cursor-help" title="${remainingNames}">+${remaining} 項</span>`;
            }
            return html;
        }

        // --- REPORT TEMPLATE FUNCTIONS ---
        function populateTemplateSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">-- 選擇報表組合 --</option>';
            reportTemplates.forEach(template => {
                const reportCount = template.reports.length === 0 ? '全部' : template.reports.length + '份';
                select.innerHTML += `<option value="${template.id}">${template.name} (${reportCount})</option>`;
            });
        }

        function populateStaffSelect(selectId, includeVacancy = false) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            // 根據當前體系視角過濾人員
            const filteredStaff = staffList.filter(staff => {
                if (currentBusinessSystem === 'all') return true;
                return staff.businessSystem === currentBusinessSystem;
            });

            filteredStaff.forEach(staff => {
                const displayName = staff.nickname ? `${staff.name} ${staff.nickname}` : staff.name;
                select.innerHTML += `<option value="${staff.name}">${displayName} (${staff.role})</option>`;
            });
            if (includeVacancy) {
                select.innerHTML += '<option value="9999">-- 暫時懸缺 --</option>';
            }
        }

        function applyReportTemplate(type) {
            const selectId = `${type}-template-select`;
            const templateId = document.getElementById(selectId).value;
            if (!templateId) return;

            const template = reportTemplates.find(t => t.id === templateId);
            if (!template) return;

            // 取得要勾選的報表列表
            const reportsToCheck = template.reports.length === 0 ? reportList.map(r => r.code) : template.reports;

            // 先取消全選
            const listId = `${type}-report-list`;
            const container = document.getElementById(listId);
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

            // 勾選組合內的報表
            reportsToCheck.forEach(code => {
                const checkbox = container.querySelector(`input[value="${code}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }

        // --- GROUP STORE SELECTION ---
        function toggleAllStoresNew(checkbox) {
            const container = document.getElementById('group-store-checkboxes');
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function toggleAllStoresEdit(checkbox) {
            const container = document.getElementById('edit-group-store-checkboxes');
            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }

        function updateAllStoresCheckbox(type) {
            const containerId = type === 'new' ? 'group-store-checkboxes' : 'edit-group-store-checkboxes';
            const allCheckboxId = type === 'new' ? 'new-group-all-stores' : 'edit-group-all-stores';
            const container = document.getElementById(containerId);
            const allCheckbox = document.getElementById(allCheckboxId);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            allCheckbox.checked = allChecked;
        }

        // --- GROUP ACTIONS ---

        function deleteReportTemplate(index) {
            const template = reportTemplates[index];
            if (confirm(`確定要刪除報表組合「${template.name}」嗎？`)) {
                showToast('syncing');
                setTimeout(() => {
                    reportTemplates.splice(index, 1);
                    renderReportTemplates();
                    showToast('success', '報表組合已刪除！');
                }, 500);
            }
        }

        // --- INTERACTION ---
        function switchTab(tab) {
            document.getElementById('view-store').classList.toggle('hidden', tab !== 'store');
            document.getElementById('view-template').classList.toggle('hidden', tab !== 'template');
            document.getElementById('view-settings').classList.toggle('hidden', tab !== 'settings');

            // Desktop tabs
            const activeClass = "border-primary text-primary whitespace-nowrap py-4 px-1 border-b-2 font-bold text-base flex items-center transition-colors";
            const inactiveClass = "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-bold text-base flex items-center transition-colors";

            document.getElementById('tab-store').className = tab === 'store' ? activeClass : inactiveClass;
            document.getElementById('tab-template').className = tab === 'template' ? activeClass : inactiveClass;
            document.getElementById('tab-settings').className = tab === 'settings' ? activeClass : inactiveClass;

            // Mobile bottom nav
            ['store', 'template', 'settings'].forEach(t => {
                const btn = document.getElementById('bnav-' + t);
                if (btn) {
                    if (t === tab) {
                        btn.classList.add('m-bnav-active');
                        btn.classList.remove('text-gray-400');
                    } else {
                        btn.classList.remove('m-bnav-active');
                        btn.classList.add('text-gray-400');
                    }
                }
            });

            // Scroll to top on tab switch
            window.scrollTo(0, 0);

            if(tab === 'store') renderStores();
            else if(tab === 'template') renderReportTemplates();
            else if(tab === 'settings') initSettingsTab();
        }

        function autoGenEmail() {
            const code = document.getElementById('store-code').value;
            if(code) {
                document.getElementById('store-email').value = `${code.toLowerCase()}.manager@company.com`;
            }
        }

        function openModal(type, index) {
            currentModalType = type;
            currentIndex = index;
            const modal = document.getElementById('modal');
            const title = document.getElementById('modal-title');
            
            // Hide all forms
            document.querySelectorAll('.form-section').forEach(el => el.classList.add('hidden'));

            if(type === 'primary') {
                title.innerText = `指派 ${stores[index].name} 主要店經理`;
                document.getElementById('form-primary').classList.remove('hidden');
                populateStaffSelect('primary-select', true);
            } else if (type === 'granular') {
                title.innerText = `新增人員至 ${stores[index].name}`;
                document.getElementById('form-granular').classList.remove('hidden');
                populateStaffSelect('granular-select');
                document.getElementById('granular-report-search').value = '';
                generateReportCheckboxes('granular-report-list', 'granular-scopes', []);
                populateTemplateSelect('granular-template-select');
            } else if (type === 'new-store') {
                title.innerText = "新展店設定";
                document.getElementById('form-new-store').classList.remove('hidden');
                document.getElementById('store-code').value = '';
                document.getElementById('store-name').value = '';
                document.getElementById('store-email').value = '';
            } else if (type === 'new-group') {
                title.innerText = "新增管理群組";
                document.getElementById('form-new-group').classList.remove('hidden');
                document.getElementById('group-name').value = '';
                // 重置全選狀態
                document.getElementById('new-group-all-stores').checked = false;
                // 動態生成門市選項
                const storeCheckboxes = document.getElementById('group-store-checkboxes');
                storeCheckboxes.innerHTML = stores.map((s, i) => `
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" name="new-group-stores" value="${s.name}" class="text-primary rounded" onchange="updateAllStoresCheckbox('new')">
                        <span class="text-sm">${s.name}</span>
                        <span class="text-xs text-gray-400">(${s.code})</span>
                    </label>
                `).join('');
                // 初始化管理者下拉選單
                populateStaffSelect('group-manager-select');
                // 初始化報表列表
                document.getElementById('group-report-search').value = '';
                generateReportCheckboxes('group-report-list', 'group-scopes', []);
                populateTemplateSelect('group-template-select');
            } else if (type === 'edit-group') {
                title.innerText = `編輯群組：${groups[index].name}`;
                document.getElementById('form-edit-group').classList.remove('hidden');
                document.getElementById('edit-group-name').value = groups[index].name;
                // 檢查是否為「所有門市」
                const isAllStores = groups[index].stores.includes('(所有門市)');
                document.getElementById('edit-group-all-stores').checked = isAllStores;
                // 動態生成門市選項
                const editStoreCheckboxes = document.getElementById('edit-group-store-checkboxes');
                editStoreCheckboxes.innerHTML = stores.map(s => `
                    <label class="flex items-center space-x-2 p-1 hover:bg-gray-50 rounded">
                        <input type="checkbox" name="edit-group-stores" value="${s.name}" ${isAllStores || groups[index].stores.includes(s.name) ? 'checked' : ''} class="text-primary rounded" onchange="updateAllStoresCheckbox('edit')">
                        <span class="text-sm">${s.name}</span>
                        <span class="text-xs text-gray-400">(${s.code})</span>
                    </label>
                `).join('');
                // 顯示現有管理者
                const managersList = document.getElementById('edit-group-managers-list');
                if (groups[index].managers.length === 0) {
                    managersList.innerHTML = '<span class="text-xs text-gray-400">尚無管理者</span>';
                } else {
                    managersList.innerHTML = groups[index].managers.map((m, mIdx) => {
                        const badges = m.scopes.map(s => {
                            let color = s==='A'?'bg-red-100 text-red-700': s==='B'?'bg-green-100 text-green-700':'bg-purple-100 text-purple-700';
                            return `<span class="px-1.5 rounded text-[10px] font-bold ${color} border border-black/5">${s}</span>`;
                        }).join(' ');
                        return `
                            <div class="flex items-center text-sm bg-gray-50 px-2 py-1.5 rounded border border-gray-200">
                                <i class="fa-solid fa-user-shield text-gray-400 mr-2"></i>
                                <span class="font-medium mr-2">${m.name}</span>
                                <div class="flex gap-1">${badges}</div>
                            </div>
                        `;
                    }).join('');
                }
            } else if (type === 'group-manager') {
                title.innerText = `新增管理者至：${groups[index].name}`;
                document.getElementById('form-group-manager').classList.remove('hidden');
                populateStaffSelect('add-group-manager-select');
                document.getElementById('manager-report-search').value = '';
                generateReportCheckboxes('manager-report-list', 'manager-scopes', []);
                populateTemplateSelect('manager-template-select');
            } else if (type === 'edit-store') {
                title.innerText = "門市設定與 Role Email 維護";
                document.getElementById('form-edit-store').classList.remove('hidden');
                document.getElementById('edit-store-name').value = stores[index].name;
                document.getElementById('edit-store-code').value = stores[index].code;
                document.getElementById('edit-store-email').value = stores[index].roleEmail;
            } else if (type === 'new-template') {
                title.innerText = "新增報表組合";
                document.getElementById('form-new-template').classList.remove('hidden');
                document.getElementById('template-name').value = '';
                document.getElementById('template-description').value = '';
                document.getElementById('template-report-search').value = '';
                generateReportCheckboxes('template-report-list', 'template-scopes', []);
            } else if (type === 'edit-template') {
                const template = reportTemplates[index];
                title.innerText = `編輯報表組合：${template.name}`;
                document.getElementById('form-edit-template').classList.remove('hidden');
                document.getElementById('edit-template-id').value = template.id;
                document.getElementById('edit-template-name').value = template.name;
                document.getElementById('edit-template-description').value = template.description;
                document.getElementById('edit-template-report-search').value = '';
                // 如果 reports 為空陣列，代表全選
                const checkedReports = template.reports.length === 0 ? reportList.map(r => r.code) : template.reports;
                generateReportCheckboxes('edit-template-report-list', 'edit-template-scopes', checkedReports);
            } else if (type === 'new-staff') {
                title.innerText = "新增人員";
                document.getElementById('form-new-staff').classList.remove('hidden');
                document.getElementById('staff-name').value = '';
                document.getElementById('staff-nickname').value = '';
                document.getElementById('staff-role').value = '店長';
            } else if (type === 'edit-staff') {
                const staff = staffList[index];
                title.innerText = `編輯人員：${staff.name}`;
                document.getElementById('form-edit-staff').classList.remove('hidden');
                document.getElementById('edit-staff-id').value = staff.id;
                document.getElementById('edit-staff-name').value = staff.name;
                document.getElementById('edit-staff-nickname').value = staff.nickname || '';
                document.getElementById('edit-staff-role').value = staff.role;
            }

            modal.classList.remove('hidden');
            modal.querySelector('div[class*="transform"]').classList.add('animate-scale-in');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        function saveData() {
            closeModal();
            showToast('syncing');

            setTimeout(() => {
                if(currentModalType === 'primary') {
                    const sel = document.getElementById('primary-select');
                    const name = sel.options[sel.selectedIndex].text.split(' (')[0];
                    if(sel.value === '9999') stores[currentIndex].primaryManager = null;
                    else stores[currentIndex].primaryManager = { name: name, status: 'active' };
                } else if (currentModalType === 'granular') {
                    const sel = document.getElementById('granular-select');
                    const name = sel.options[sel.selectedIndex].text.split(' (')[0];
                    const role = sel.options[sel.selectedIndex].text.split(' (')[1].replace(')','');
                    const scopes = getSelectedReports('granular-scopes');
                    if(scopes.length > 0) {
                        stores[currentIndex].authorizedUsers.push({ name, role, scopes });
                    }
                } else if (currentModalType === 'new-store') {
                    const code = document.getElementById('store-code').value || 'NEW';
                    const name = document.getElementById('store-name').value || '新門市';
                    const email = document.getElementById('store-email').value || `${code.toLowerCase()}.manager@company.com`;
                    stores.push({ code, name, roleEmail: email, primaryManager: null, authorizedUsers: [] });
                } else if (currentModalType === 'new-group') {
                    const name = document.getElementById('group-name').value || '新群組';
                    let selectedStores = [];
                    document.querySelectorAll('input[name="new-group-stores"]:checked').forEach(cb => selectedStores.push(cb.value));
                    // 如果全選，標記為「所有門市」
                    if (selectedStores.length === stores.length) {
                        selectedStores = ['(所有門市)'];
                    }
                    const managerName = document.getElementById('group-manager-select').value;
                    const managerScopes = getSelectedReports('group-scopes');
                    const managers = managerScopes.length > 0 ? [{ name: managerName, scopes: managerScopes }] : [];
                    groups.push({
                        name,
                        stores: selectedStores.length > 0 ? selectedStores : ['(未指定)'],
                        managers
                    });
                } else if (currentModalType === 'edit-group') {
                    groups[currentIndex].name = document.getElementById('edit-group-name').value;
                    let selectedStores = [];
                    document.querySelectorAll('input[name="edit-group-stores"]:checked').forEach(cb => selectedStores.push(cb.value));
                    // 如果全選，標記為「所有門市」
                    if (selectedStores.length === stores.length) {
                        selectedStores = ['(所有門市)'];
                    }
                    groups[currentIndex].stores = selectedStores.length > 0 ? selectedStores : ['(未指定)'];
                } else if (currentModalType === 'group-manager') {
                    const managerName = document.getElementById('add-group-manager-select').value;
                    const scopes = getSelectedReports('manager-scopes');
                    if (scopes.length > 0) {
                        // 檢查是否已存在同名管理者
                        const existingIdx = groups[currentIndex].managers.findIndex(m => m.name === managerName);
                        if (existingIdx >= 0) {
                            // 更新權限
                            groups[currentIndex].managers[existingIdx].scopes = scopes;
                        } else {
                            groups[currentIndex].managers.push({ name: managerName, scopes });
                        }
                    }
                } else if (currentModalType === 'edit-store') {
                    stores[currentIndex].name = document.getElementById('edit-store-name').value;
                    // Code is disabled
                    stores[currentIndex].roleEmail = document.getElementById('edit-store-email').value;
                } else if (currentModalType === 'new-template') {
                    const name = document.getElementById('template-name').value || '新報表組合';
                    const description = document.getElementById('template-description').value || '';
                    const reports = getSelectedReports('template-scopes');
                    // 產生新的 ID
                    const maxId = reportTemplates.reduce((max, t) => {
                        const num = parseInt(t.id.replace('RT', ''));
                        return num > max ? num : max;
                    }, 0);
                    const newId = `RT${String(maxId + 1).padStart(3, '0')}`;
                    // 如果全選則存空陣列
                    const finalReports = reports.length === reportList.length ? [] : reports;
                    reportTemplates.push({ id: newId, name, description, reports: finalReports });
                } else if (currentModalType === 'edit-template') {
                    const name = document.getElementById('edit-template-name').value;
                    const description = document.getElementById('edit-template-description').value;
                    const reports = getSelectedReports('edit-template-scopes');
                    // 如果全選則存空陣列
                    const finalReports = reports.length === reportList.length ? [] : reports;
                    reportTemplates[currentIndex].name = name;
                    reportTemplates[currentIndex].description = description;
                    reportTemplates[currentIndex].reports = finalReports;
                } else if (currentModalType === 'new-staff') {
                    const name = document.getElementById('staff-name').value.trim();
                    const nickname = document.getElementById('staff-nickname').value.trim();
                    const role = document.getElementById('staff-role').value;
                    if (name) {
                        // 產生新的 ID
                        const maxId = staffList.reduce((max, s) => {
                            const num = parseInt(s.id.replace('S', ''));
                            return num > max ? num : max;
                        }, 0);
                        const newId = `S${String(maxId + 1).padStart(3, '0')}`;
                        staffList.push({ id: newId, name, nickname, role });
                    }
                } else if (currentModalType === 'edit-staff') {
                    const name = document.getElementById('edit-staff-name').value.trim();
                    const nickname = document.getElementById('edit-staff-nickname').value.trim();
                    const role = document.getElementById('edit-staff-role').value;
                    if (name) {
                        staffList[currentIndex].name = name;
                        staffList[currentIndex].nickname = nickname;
                        staffList[currentIndex].role = role;
                    }
                }

                renderStores();
                renderGroups();
                renderReportTemplates();
                renderStaff();
                showToast('success');
            }, 800);
        }

        function showToast(state, customMsg) {
            const toast = document.getElementById('toast');
            const iconBg = document.getElementById('toast-icon-bg');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-msg');

            toast.classList.remove('hidden', 'translate-y-10', 'opacity-0');

            if(state === 'syncing') {
                iconBg.className = "inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg";
                icon.className = "fa-solid fa-rotate animate-spin";
                msg.innerText = "正在同步 Google Drive...";
            } else {
                iconBg.className = "inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg";
                icon.className = "fa-solid fa-check";
                msg.innerText = customMsg || "設定已生效！";
                setTimeout(() => {
                    toast.classList.add('translate-y-10', 'opacity-0');
                    setTimeout(() => toast.classList.add('hidden'), 300);
                }, 2000);
            }
        }

        // --- AI LOGIC ---
        function openAIModal() {
            document.getElementById('ai-modal').classList.remove('hidden');
            document.getElementById('ai-result').classList.add('hidden');
            document.getElementById('ai-error').classList.add('hidden');
            document.getElementById('ai-input').value = '';
            document.getElementById('ai-input').focus();
        }

        function closeAIModal() {
            document.getElementById('ai-modal').classList.add('hidden');
        }

        function fillAIInput(text) {
            document.getElementById('ai-input').value = text;
        }

        async function submitAICommand() {
            const input = document.getElementById('ai-input').value;
            if(!input.trim()) return;

            const loading = document.getElementById('ai-loading');
            const resultDiv = document.getElementById('ai-result');
            const errorDiv = document.getElementById('ai-error');
            const resultText = document.getElementById('ai-result-text');
            const errorText = document.getElementById('ai-error-text');

            loading.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            errorDiv.classList.add('hidden');

            try {
                // 1. Prepare Context for LLM
                const currentStoreNames = stores.map(s => s.name).join(', ');
                const context = `
                    Current Stores: ${currentStoreNames}
                    User Command: ${input}
                    
                    You are an AI assistant for a permission system. Parse the user's natural language command into a JSON action.
                    Output JSON format ONLY. No markdown.
                    
                    Action Types:
                    1. ASSIGN_PRIMARY: { "type": "ASSIGN_PRIMARY", "storeName": "Target Store Name", "managerName": "Name" }
                    2. ADD_GRANULAR: { "type": "ADD_GRANULAR", "storeName": "Target Store Name", "userName": "Name", "role": "Title", "scopes": ["A"|"B"|"C"] }
                    3. CREATE_STORE: { "type": "CREATE_STORE", "name": "Store Name", "code": "CODE" }
                    4. UPDATE_STORE_EMAIL: { "type": "UPDATE_STORE_EMAIL", "storeName": "Target Store Name", "newEmail": "email@address" }
                       - Matches: "把[店名]的 Email 改成 [email]", "修改[店名]的 Role Email 為 [email]"
                    
                    If store name is fuzzy, try to match closest from Current Stores list.
                `;

                // 2. Call Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: context }] }]
                    })
                });

                if(!response.ok) throw new Error('API Request Failed');
                
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const action = JSON.parse(jsonStr);

                // 3. Execute Action
                let successMsg = "";

                if (action.type === 'ASSIGN_PRIMARY') {
                    const store = stores.find(s => s.name.includes(action.storeName) || action.storeName.includes(s.name));
                    if (store) {
                        store.primaryManager = { name: action.managerName, status: 'active' };
                        successMsg = `已成功將 ${store.name} 的主要店長變更為 ${action.managerName}`;
                    } else { throw new Error(`找不到門市：${action.storeName}`); }
                } 
                else if (action.type === 'ADD_GRANULAR') {
                    const store = stores.find(s => s.name.includes(action.storeName) || action.storeName.includes(s.name));
                    if (store) {
                        store.authorizedUsers.push({ name: action.userName, role: action.role || '專員', scopes: action.scopes });
                        successMsg = `已授權 ${action.userName} 存取 ${store.name} 的 ${action.scopes.join(',')} 報表`;
                    } else { throw new Error(`找不到門市：${action.storeName}`); }
                }
                else if (action.type === 'CREATE_STORE') {
                    const newCode = action.code || 'NEW';
                    const newEmail = `${newCode.toLowerCase()}.manager@company.com`;
                    stores.push({ code: newCode, name: action.name, roleEmail: newEmail, primaryManager: null, authorizedUsers: [] });
                    successMsg = `已建立新門市：${action.name}`;
                }
                else if (action.type === 'UPDATE_STORE_EMAIL') {
                    const store = stores.find(s => s.name.includes(action.storeName) || action.storeName.includes(s.name));
                    if (store) {
                        store.roleEmail = action.newEmail;
                        successMsg = `已更新 ${store.name} 的 Role Email 為 ${action.newEmail}`;
                    } else { throw new Error(`找不到門市：${action.storeName}`); }
                }
                else {
                    throw new Error("無法辨識指令，請試著說得更清楚一點。");
                }

                renderStores();
                resultText.innerText = successMsg;
                resultDiv.classList.remove('hidden');
                showToast('success', 'AI 指令執行成功！');

            } catch (err) {
                console.error(err);
                errorText.innerText = "指令執行失敗：" + (err.message || "請檢查 API Key");
                errorDiv.classList.remove('hidden');
            } finally {
                loading.classList.add('hidden');
            }
        }

        // ========== SETTINGS TAB FUNCTIONS ==========
        let wizardStep = 1;
        let currentReportMgmtFilter = 'all';

        function initSettingsTab() {
            populateWizardManagerSelect();
            renderReportMgmtList();
            renderGDriveSyncList();
        }

        function openSettingsInNewTab() {
            window.open('store-report-gdrive.html', '_blank');
        }

        function switchSettingsTab(tab) {
            document.getElementById('settings-new-store').classList.toggle('hidden', tab !== 'new-store');
            document.getElementById('settings-reports').classList.toggle('hidden', tab !== 'reports');
            document.getElementById('settings-gdrive').classList.toggle('hidden', tab !== 'gdrive');

            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.classList.remove('active', 'border-primary', 'text-primary');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            const activeBtn = document.getElementById(`settings-tab-${tab}`);
            activeBtn.classList.add('active', 'border-primary', 'text-primary');
            activeBtn.classList.remove('border-transparent', 'text-gray-500');

            if (tab === 'reports') renderReportMgmtList();
            if (tab === 'gdrive') renderGDriveSyncList();
        }

        // --- New Store Wizard ---
        function populateWizardManagerSelect() {
            const select = document.getElementById('wizard-store-manager');
            if (!select) return;
            select.innerHTML = '<option value="">-- 暫不指派 --</option>';
            
            // 根據當前體系視角過濾人員
            const filteredStaff = staffList.filter(staff => {
                if (currentBusinessSystem === 'all') return true;
                return staff.businessSystem === currentBusinessSystem;
            });

            filteredStaff.forEach(staff => {
                const display = staff.nickname ? `${staff.name} ${staff.nickname}` : staff.name;
                select.innerHTML += `<option value="${staff.id}">${display} (${staff.role})</option>`;
            });
        }

        function wizardAutoEmail() {
            const code = document.getElementById('wizard-store-code').value.trim();
            if (code) {
                document.getElementById('wizard-store-email').value = `${code.toLowerCase()}.manager@company.com`;
            }
        }

        function updateWizardStepUI() {
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`new-store-step-${i}`);
                const contentEl = document.getElementById(`new-store-content-${i}`);
                if (!stepEl || !contentEl) continue;

                contentEl.classList.toggle('hidden', i !== wizardStep);

                if (i < wizardStep) {
                    stepEl.className = 'w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-green-500 text-white flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2';
                    stepEl.innerHTML = '<i class="fa-solid fa-check"></i>';
                } else if (i === wizardStep) {
                    stepEl.className = 'w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2';
                    stepEl.textContent = i;
                } else {
                    stepEl.className = 'w-8 h-8 sm:w-10 sm:h-10 mx-auto rounded-full bg-gray-200 text-gray-500 flex items-center justify-center font-bold text-sm sm:text-base mb-1 sm:mb-2';
                    stepEl.textContent = i;
                }
            }
            document.getElementById('wizard-prev').classList.toggle('hidden', wizardStep === 1);
            document.getElementById('wizard-next').classList.toggle('hidden', wizardStep === 4);
            document.getElementById('wizard-submit').classList.toggle('hidden', wizardStep !== 4);
        }

        function wizardNext() {
            if (wizardStep === 1) {
                const code = document.getElementById('wizard-store-code').value.trim();
                const name = document.getElementById('wizard-store-name').value.trim();
                if (!code || !name) {
                    showToast('error', '請填寫必填欄位');
                    return;
                }
            }
            if (wizardStep < 4) {
                wizardStep++;
                updateWizardStepUI();
                if (wizardStep === 4) updateWizardConfirmation();
            }
        }

        function wizardPrev() {
            if (wizardStep > 1) {
                wizardStep--;
                updateWizardStepUI();
            }
        }

        function updateWizardConfirmation() {
            const typeRadio = document.querySelector('input[name="new-store-type"]:checked');
            const typeMap = { 'MED': '醫美診所', 'SPA': '岩盤浴', 'OTHER': '其他' };
            document.getElementById('wizard-confirm-type').textContent = typeMap[typeRadio?.value] || '-';
            document.getElementById('wizard-confirm-code').textContent = document.getElementById('wizard-store-code').value || '-';
            document.getElementById('wizard-confirm-name').textContent = document.getElementById('wizard-store-name').value || '-';
            document.getElementById('wizard-confirm-email').textContent = document.getElementById('wizard-store-email').value || '-';

            const managerSelect = document.getElementById('wizard-store-manager');
            document.getElementById('wizard-confirm-manager').textContent = managerSelect.value ? managerSelect.options[managerSelect.selectedIndex].text : '未指派';

            const actions = [];
            if (document.getElementById('wizard-gdrive-folder')?.checked) actions.push('建立資料夾');
            if (document.getElementById('wizard-gdrive-access')?.checked) actions.push('授權 Email');
            if (document.getElementById('wizard-n8n-notify')?.checked) actions.push('通知 n8n');
            document.getElementById('wizard-confirm-gdrive').textContent = actions.length ? actions.join('、') : '無';
        }

        function wizardSubmit() {
            showToast('syncing');
            setTimeout(() => {
                const code = document.getElementById('wizard-store-code').value.trim();
                const name = document.getElementById('wizard-store-name').value.trim();
                const email = document.getElementById('wizard-store-email').value.trim();
                const typeRadio = document.querySelector('input[name="new-store-type"]:checked');

                stores.push({
                    code: code,
                    name: name,
                    roleEmail: email,
                    primaryManager: null,
                    authorizedUsers: []
                });

                // Reset wizard
                wizardStep = 1;
                document.getElementById('wizard-store-code').value = '';
                document.getElementById('wizard-store-name').value = '';
                document.getElementById('wizard-store-email').value = '';
                updateWizardStepUI();

                renderStores();
                showToast('success', `門市「${name}」已建立！`);
            }, 1000);
        }

        // --- Report Management ---
        function renderReportMgmtList() {
            const tbody = document.getElementById('report-mgmt-list');
            if (!tbody) return;

            let filtered = reportList;
            if (currentReportMgmtFilter !== 'all') {
                filtered = reportList.filter(r => r.category === currentReportMgmtFilter);
            }

            tbody.innerHTML = filtered.map((r, idx) => {
                const colors = reportCategoryColors[r.category] || reportCategoryColors['系統'];
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 font-mono font-bold text-gray-800">${r.code}</td>
                        <td class="px-4 py-3 text-gray-800">${r.name}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${colors.bg} ${colors.text}">
                                <i class="fa-solid ${colors.icon} mr-1"></i>${r.category}
                            </span>
                        </td>
                        <td class="px-4 py-3"><span class="text-green-600"><i class="fa-solid fa-circle-check mr-1"></i>啟用</span></td>
                        <td class="px-4 py-3 text-right">
                            <button class="text-primary hover:text-blue-700 mr-2"><i class="fa-solid fa-pen"></i></button>
                            <button class="text-gray-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setReportMgmtFilter(filter) {
            currentReportMgmtFilter = filter;
            document.querySelectorAll('.report-mgmt-filter').forEach(btn => {
                btn.classList.remove('active', 'bg-primary', 'text-white');
                btn.classList.add('bg-white', 'text-gray-600');
            });
            event.target.classList.add('active', 'bg-primary', 'text-white');
            event.target.classList.remove('bg-white', 'text-gray-600');
            renderReportMgmtList();
        }

        // --- Google Drive Sync ---
        function renderGDriveSyncList() {
            const container = document.getElementById('gdrive-sync-list');
            if (!container) return;

            const syncStatuses = ['ok', 'ok', 'ok', 'pending', 'ok', 'error', 'ok', 'pending'];
            container.innerHTML = stores.slice(0, 8).map((store, idx) => {
                const status = syncStatuses[idx] || 'ok';
                const statusConfig = {
                    'ok': { icon: 'fa-circle-check', color: 'text-green-500', bg: 'bg-green-50', label: '已同步' },
                    'pending': { icon: 'fa-clock', color: 'text-yellow-500', bg: 'bg-yellow-50', label: '待同步' },
                    'error': { icon: 'fa-circle-exclamation', color: 'text-red-500', bg: 'bg-red-50', label: '失敗' }
                };
                const s = statusConfig[status];
                return `
                    <div class="flex items-center justify-between px-4 py-2 ${s.bg}">
                        <div class="flex items-center">
                            <i class="fa-solid ${s.icon} ${s.color} mr-3"></i>
                            <div>
                                <div class="text-sm font-medium text-gray-800">${store.name}</div>
                                <div class="text-xs text-gray-500">${store.code}</div>
                            </div>
                        </div>
                        <span class="text-xs ${s.color}">${s.label}</span>
                    </div>
                `;
            }).join('');
        }

        function syncAllGDrive() {
            showToast('syncing');
            setTimeout(() => {
                renderGDriveSyncList();
                showToast('success', '所有門市已同步');
            }, 2000);
        }




        // ========== INIT ==========
        renderStores();
    </script>
</body>
</html>