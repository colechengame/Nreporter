# N-Report 權限邏輯關係心智圖

## 視覺化心智圖 (Mermaid)

```mermaid
mindmap
  root((N-Report<br/>權限系統))
    門市權限
      主要店經理
        繼承 Role Email
        完整報表存取
        權限可移轉
      授權人員
        細部權限控制
        指定報表範圍
        角色描述
          多店管理
          顧問
          儲備幹部
    群組權限
      區域管理群組
        包含多間門市
        可選「所有門市」
      群組管理者
        跨店報表存取
        自訂報表範圍
    報表系統
      報表分類
        營運類
        人資類
        財務類
        行銷類
        會員類
        系統類
      報表組合
        快速套用
        預設範本
        全報表組合
    人員管理
      基本資料
        姓名
        暱稱
        職位
      職位類型
        店長
        區經理
        主管
        高階主管
        專員
```

---

## 權限流向圖 (Mermaid Flowchart)

```mermaid
flowchart TB
    subgraph 人員層 ["👤 人員 (Staff)"]
        S1[店長]
        S2[區經理]
        S3[高階主管]
        S4[專員/顧問]
    end

    subgraph 權限指派層 ["🔑 權限指派"]
        PM[主要店經理<br/>Primary Manager]
        AU[授權人員<br/>Auth User]
        GM[群組管理者<br/>Group Manager]
    end

    subgraph 組織層 ["🏢 組織結構"]
        ST[門市 Store]
        GR[群組 Group]
    end

    subgraph 報表層 ["📊 報表存取"]
        RE[Role Email<br/>完整存取]
        SC[Scopes<br/>指定報表]
        TP[報表組合<br/>Template]
    end

    subgraph 報表分類 ["📁 報表分類"]
        R1[營運報表]
        R2[人資報表]
        R3[財務報表]
        R4[行銷報表]
        R5[會員報表]
        R6[系統報表]
    end

    %% 人員到權限指派
    S1 --> PM
    S1 --> AU
    S2 --> GM
    S2 --> AU
    S3 --> GM
    S4 --> AU

    %% 權限指派到組織
    PM --> ST
    AU --> ST
    GM --> GR
    GR --> |包含多個| ST

    %% 組織到報表存取
    PM --> RE
    AU --> SC
    GM --> SC

    %% 報表組合快速套用
    TP -.-> |快速套用| SC

    %% 報表存取到報表分類
    RE --> R1
    RE --> R2
    RE --> R3
    RE --> R4
    RE --> R5
    RE --> R6

    SC --> |選擇性存取| R1
    SC --> |選擇性存取| R2
    SC --> |選擇性存取| R3
    SC --> |選擇性存取| R4
    SC --> |選擇性存取| R5
    SC --> |選擇性存取| R6
```

---

## 權限繼承關係圖

```mermaid
flowchart LR
    subgraph 最高權限
        HQ[總管理處<br/>全域副本收件人]
    end

    subgraph 區域權限
        AM1[區經理 A<br/>多店管理組]
        AM2[區經理 B<br/>多店管理組]
    end

    subgraph 門市權限
        SM1[店經理 1]
        SM2[店經理 2]
        SM3[店經理 3]
        SM4[店經理 4]
    end

    subgraph 細部權限
        AU1[授權人員]
        AU2[授權人員]
    end

    HQ --> |監督| AM1
    HQ --> |監督| AM2
    AM1 --> |管理| SM1
    AM1 --> |管理| SM2
    AM2 --> |管理| SM3
    AM2 --> |管理| SM4
    SM1 --> |授權| AU1
    SM3 --> |授權| AU2
```

---

## 文字版心智圖

```
                                    ┌─────────────────────────────────────┐
                                    │      N-Report 權限系統              │
                                    └─────────────────┬───────────────────┘
                                                      │
            ┌─────────────────────┬───────────────────┼───────────────────┬─────────────────────┐
            │                     │                   │                   │                     │
            ▼                     ▼                   ▼                   ▼                     ▼
    ┌───────────────┐     ┌───────────────┐   ┌───────────────┐   ┌───────────────┐     ┌───────────────┐
    │   門市權限     │     │   群組權限     │   │   報表系統     │   │   人員管理     │     │   報表組合     │
    └───────┬───────┘     └───────┬───────┘   └───────┬───────┘   └───────┬───────┘     └───────┬───────┘
            │                     │                   │                   │                     │
    ┌───────┴───────┐     ┌───────┴───────┐   ┌───────┴───────┐   ┌───────┴───────┐     ┌───────┴───────┐
    │               │     │               │   │               │   │               │     │               │
    ▼               ▼     ▼               ▼   ▼               ▼   ▼               ▼     ▼               ▼
┌────────┐    ┌────────┐ ┌────────┐  ┌────────┐ ┌────────┐  ┌────────┐ ┌────────┐  ┌────────┐ ┌────────┐  ┌────────┐
│主要    │    │授權    │ │區域    │  │群組    │ │營運類  │  │人資類  │ │姓名    │  │職位    │ │營運    │  │人資    │
│店經理  │    │人員    │ │管理    │  │管理者  │ │報表    │  │報表    │ │暱稱    │  │類型    │ │管理    │  │報表    │
└────┬───┘    └────┬───┘ │群組    │  └────┬───┘ ├────────┤  ├────────┤ └────────┘  ├────────┤ │組合    │  │組合    │
     │             │     └────────┘       │     │財務類  │  │行銷類  │             │店長    │ └────────┘  └────────┘
     │             │                      │     │報表    │  │報表    │             │區經理  │
     ▼             ▼                      │     ├────────┤  ├────────┤             │主管    │
┌────────────┐ ┌────────────┐             │     │會員類  │  │系統類  │             │高階主管│
│繼承        │ │細部權限    │             │     │報表    │  │報表    │             │專員    │
│Role Email  │ │控制       │             │     └────────┘  └────────┘             └────────┘
│完整報表    │ │指定報表   │             │
│存取        │ │範圍       │             ▼
└────────────┘ └────────────┘     ┌────────────────┐
                                 │跨店報表存取    │
                                 │自訂報表範圍    │
                                 └────────────────┘
```

---

## 權限矩陣表

| 角色 | 門市存取 | 報表範圍 | Role Email | 群組管理 | 說明 |
|------|---------|---------|------------|---------|------|
| **高階主管** | 所有門市 | 全部報表 | ✓ 副本 | ✓ | 全域監督權限 |
| **區經理** | 管轄門市群組 | 自訂範圍 | ✗ | ✓ | 多店管理 |
| **主要店經理** | 單一門市 | 全部報表 | ✓ 主要 | ✗ | 門市完整權限 |
| **授權人員** | 單一門市 | 指定報表 | ✗ | ✗ | 細部權限 |
| **專員/顧問** | 指定門市 | 指定報表 | ✗ | ✗ | 特定任務 |

---

## 權限判斷流程

```mermaid
flowchart TD
    START([使用者請求報表]) --> CHECK1{是否為<br/>高階主管?}
    CHECK1 --> |是| ALLOW1[✅ 允許存取<br/>所有報表]
    CHECK1 --> |否| CHECK2{是否為<br/>群組管理者?}

    CHECK2 --> |是| CHECK3{報表在<br/>授權範圍?}
    CHECK2 --> |否| CHECK4{是否為<br/>主要店經理?}

    CHECK3 --> |是| CHECK5{門市在<br/>管轄群組?}
    CHECK3 --> |否| DENY1[❌ 拒絕存取]

    CHECK5 --> |是| ALLOW2[✅ 允許存取]
    CHECK5 --> |否| DENY2[❌ 拒絕存取]

    CHECK4 --> |是| CHECK6{是該門市<br/>的報表?}
    CHECK4 --> |否| CHECK7{是否為<br/>授權人員?}

    CHECK6 --> |是| ALLOW3[✅ 允許存取<br/>透過 Role Email]
    CHECK6 --> |否| DENY3[❌ 拒絕存取]

    CHECK7 --> |是| CHECK8{報表在<br/>Scopes 內?}
    CHECK7 --> |否| DENY4[❌ 拒絕存取]

    CHECK8 --> |是| ALLOW4[✅ 允許存取]
    CHECK8 --> |否| DENY5[❌ 拒絕存取]
```

---

## 實際案例說明

### 案例 1：Tina (區經理) 的權限範圍

```
吳佳蓉 Tina (區經理)
    │
    ├── 主要店經理身份
    │   └── 板橋光澤醫美 ──→ Role Email: dr.shine.manager1@gmail.com
    │                        └── 全部報表存取權
    │
    └── 多店管理群組
        ├── 忠孝光澤
        ├── 三峽光澤診所
        ├── 板橋岩盤浴
        └── 忠孝岩盤浴
            └── 各門市指定報表範圍
```

### 案例 2：全域副本收件人

```
全域副本收件人群組
    │
    ├── 包含：(所有門市)
    │
    └── 管理者
        ├── 協理 ──────→ 全部報表
        ├── William ───→ 全部報表
        └── Arthur ────→ 全部報表
```

---

## 資料關聯圖 (ER Diagram)

```mermaid
erDiagram
    STAFF ||--o{ STORE_MANAGER : "擔任"
    STAFF ||--o{ STORE_AUTH_USER : "被授權"
    STAFF ||--o{ GROUP_MANAGER : "管理"

    STORE ||--o{ STORE_MANAGER : "有"
    STORE ||--o{ STORE_AUTH_USER : "包含"
    STORE ||--o{ GROUP_STORE : "屬於"

    GROUP ||--o{ GROUP_STORE : "包含"
    GROUP ||--o{ GROUP_MANAGER : "有"

    STORE_AUTH_USER ||--o{ STORE_AUTH_SCOPE : "擁有"
    GROUP_MANAGER ||--o{ GROUP_MANAGER_SCOPE : "擁有"

    REPORT ||--o{ STORE_AUTH_SCOPE : "被指派"
    REPORT ||--o{ GROUP_MANAGER_SCOPE : "被指派"
    REPORT ||--o{ TEMPLATE_REPORT : "屬於"

    REPORT_TEMPLATE ||--o{ TEMPLATE_REPORT : "包含"

    STAFF {
        string id PK
        string name
        string nickname
        string role
    }

    STORE {
        string id PK
        string code
        string name
        string type
        string roleEmail
    }

    GROUP {
        string id PK
        string name
        boolean isAllStores
    }

    REPORT {
        string id PK
        string code
        string name
        string category
    }

    REPORT_TEMPLATE {
        string id PK
        string name
        boolean isAllReports
    }
```

---

## 快速參考卡

```
╔══════════════════════════════════════════════════════════════════╗
║                    N-Report 權限快速參考                          ║
╠══════════════════════════════════════════════════════════════════╣
║                                                                  ║
║  📍 門市權限                                                      ║
║     • 主要店經理 = Role Email + 全報表                            ║
║     • 授權人員 = 指定報表 (Scopes)                                ║
║                                                                  ║
║  📦 群組權限                                                      ║
║     • 群組 = 多個門市的集合                                       ║
║     • 群組管理者 = 跨店 + 指定報表                                ║
║                                                                  ║
║  📋 報表組合                                                      ║
║     • 預設範本快速套用                                            ║
║     • 空陣列 = 全部報表                                           ║
║                                                                  ║
║  🔄 權限優先級                                                    ║
║     高階主管 > 群組管理者 > 主要店經理 > 授權人員                   ║
║                                                                  ║
╚══════════════════════════════════════════════════════════════════╝
```
